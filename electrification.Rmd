---
title: "Commercial Building Electrification at Scale"
 
output: 
  html_document:
    code_folding: hide

---

```{r Setup, echo=FALSE, message=FALSE, warning=FALSE}



my_packages <- c("tidyverse", "vroom" , "janitor" , "glue" ,  "tsibble" , "tidytext","lubridate", "fable", "tsibbledata", "ggplot2", "forecast", "tseries", "rio", "zoo", "readxl", "tsibbledata", "knitr", "kableExtra", "formattable") 
invisible( lapply(my_packages, require, character.only = TRUE))

#Choose one working site:
 place <- "Home"
# place <-  "work"


#Set proper working Dir 
if (place == "Home"){setwd("C:/Users/paulr/Documents/R/cbwg")} else
{setwd("C:/Users/prode/Documents/R/cbwg")}

# Check for data directory and if one is not present then make it
if (!file.exists("data")) {
  dir.create("data")}
  
# Set up the "not in" operator for later use. 
  `%!in%` <- Negate(`%in%`)
  
# Set number of Types to include in analysis. 
  "T" <- 100

rm(place, my_packages )
  
# Read in data 

LL97Text <- "https://www1.nyc.gov/assets/buildings/local_laws/ll97of2019.pdf"

L84_2015 <- read_excel("data/2015_nyc_benchmarking.xlsx", sheet = "2015 Data Reported in 2016", col_names = TRUE, na = "NA", col_types = NULL )%>% mutate(Sheet = "Information and Metrics") %>%    mutate(Data = "2015") 

L84_2015 %>%
  select( "Record Number", "Property Name", "NYC Borough, Block and Lot (BBL)", "Street Number","Street Name" , "Zip Code", "Borough", "Property GFA - Self-reported (ft²)", "Primary Property Type - Self Selected", "Year Built", "Number of Buildings - Self-reported", "Fuel Oil #1 Use (kBtu)", "Fuel Oil #2 Use (kBtu)", "Fuel Oil #4 Use (kBtu)", "Fuel Oil #5 & 6 Use (kBtu)", "Diesel #2 Use (kBtu)", "District Steam Use (kBtu)", "Natural Gas Use (kBtu)", "Electricity Use - Grid Purchase (kBtu)", "Water Use (All Water Sources) (kgal)","Total GHG Emissions (Metric Tons CO2e)", Data ) %>%
  data.frame() -> L84_2015

# Feature engineering to make consistent with base data frame. 
  L84_2015$Address <- paste(L84_2015$Street.Number, L84_2015$Street.Name, sep = ' ')
  L84_2015[-(4:5) ] -> L84_2015
  L84_2015 <- L84_2015 %>% relocate(Address, .after = NYC.Borough..Block.and.Lot..BBL.) 

  colnames(L84_2015) <- c( "id", "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "GHG", "Data" )

 
L84_2015[c(7,10:21)] <- apply(L84_2015[c(7,10:21)], 2, as.numeric )
L84_2015[is.na(L84_2015)] <-0
L84_2015$Type <- as.factor(L84_2015$Type)
L84_2015 <- L84_2015 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect)) %>%
  mutate(EUI = T.Energy/GSF) %>%
  relocate(T.Energy, .after = Address) %>% 
  relocate(EUI, .after = T.Energy) %>% 
  mutate("Type" = fct_lump(Type, n=T, w = T.Energy))  %>% 
  arrange(id, T.Energy) 

# Remove duplicates 

L84_2015 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0 ) %>% 
  filter(GSF > 25000) %>% 
  filter(EUI <500 ) %>% 
  filter(EUI > 5) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2015


# Consolidate BBL's 
L84_2015$BBL <- gsub("-", "", L84_2015$BBL)
L84_2015$BBL <- gsub("/", "", L84_2015$BBL)
L84_2015$BBL <- gsub(",", ";", L84_2015$BBL)
strsplit(L84_2015$BBL, ';', fixed=T) -> L84_2015$BBL
L84_2015$BBL <- L84_2015$BBL %>% as.character(L84_2015$BBL) 

# add tags for small, med-sized and large properties. 

L84_2015 <- L84_2015 %>% 
  mutate("SizeBin" = cut(L84_2015$GSF, breaks = c(0, 25000, 50000, 500000,10000000), include.lowest = TRUE, labels = c("Small", "MidSized", "Large", "Large"), right = TRUE)) %>% 
  relocate(SizeBin, .after = GSF)

L84_2015[c(7,12,14)] <- apply(L84_2015[c(7,12,14)], 2, as.numeric )


L84_2016 <- read_excel("data/2016_nyc_benchmarking.xlsx", sheet = "Information and Metrics", col_names = TRUE, na = "NA", col_types = NULL) 

L84_2016 %>% 
  mutate(Data = "2016") %>%
  select(`Property Id`, `Property Name`, `BBL - 10 digits`, `Address 1 (self-reported)`, `Postal Code`, Borough, `DOF Gross Floor Area`, `Primary Property Type - Self Selected`, `Year Built`, `Number of Buildings - Self-reported`,`Fuel Oil #1 Use (kBtu)`, `Fuel Oil #2 Use (kBtu)`, `Fuel Oil #4 Use (kBtu)`, `Fuel Oil #5 & 6 Use (kBtu)`, `Diesel #2 Use (kBtu)`, `District Steam Use (kBtu)`, `Natural Gas Use (kBtu)`, `Electricity Use - Grid Purchase (kBtu)`, `Water Use (All Water Sources) (kgal)`,"Total GHG Emissions (Metric Tons CO2e)" , Data ) %>%
  data.frame() -> L84_2016


colnames(L84_2016) <- c("id", "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water","GHG", "Data") 

L84_2016[c(7,12:21)] <- apply(L84_2016[c(7,12:21)], 2, as.numeric )
L84_2016$id <- as.numeric(L84_2016$id)
L84_2016[is.na(L84_2016)] <-0
L84_2016$Type <- as.factor(L84_2016$Type)
L84_2016 <- L84_2016 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect)) %>%
  mutate(EUI = T.Energy/GSF) %>%
  relocate(T.Energy, .after = Address) %>% 
  relocate(EUI, .after = T.Energy) %>% 
  mutate("Type" = fct_lump(Type, n=T, w = T.Energy))  %>% 
  arrange(id, T.Energy) 

# Remove duplicates 

L84_2016 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0 ) %>% 
  filter(GSF > 25000) %>% 
  filter(EUI <500 ) %>% 
  filter(EUI > 5) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2016

# Consolidate BBL's 
L84_2016$BBL <- gsub("-", "", L84_2016$BBL)
L84_2016$BBL <- gsub("/", "", L84_2016$BBL)
L84_2016$BBL <- gsub(",", ";", L84_2016$BBL)
strsplit(L84_2016$BBL, ';', fixed=T) -> L84_2016$BBL
L84_2016$BBL <- L84_2016$BBL %>% as.character(L84_2016$BBL) 


# add tags for small, med-sized and large properties. 

L84_2016 <- L84_2016 %>% 
  mutate("SizeBin" = cut(L84_2016$GSF, breaks = c(0, 25000, 50000, 500000,10000000), include.lowest = TRUE, labels = c("Small", "MidSized", "Large", "Large"), right = TRUE)) %>% 
  relocate(SizeBin, .after = GSF)

L84_2016[c(7,12,14)] <- apply(L84_2016[c(7,12,14)], 2, as.numeric )

L84_2017 <- read_csv("data/Energy_and_Water_Data_Disclosure_for_Local_Law_84_2018__Data_for_Calendar_Year_2017_.csv", col_names = TRUE, na = "NA" )

L84_2017 %>% mutate(Data = "2017") %>% 
  select( `Property Id`, `Property Name`, `NYC Borough, Block and Lot (BBL)`, `Address 1`, `Postcode`, `City`, `Property GFA - Self-Reported (ft²)`, `Primary Property Type - Self Selected`, `Year Built`, `Number of Buildings`,`Fuel Oil #1 Use (kBtu)`, `Fuel Oil #2 Use (kBtu)`, `Fuel Oil #4 Use (kBtu)`, `Fuel Oil #5 & 6 Use (kBtu)`, `Diesel #2 Use (kBtu)`, `District Steam Use (kBtu)`, `Natural Gas Use (kBtu)`, `Electricity Use - Grid Purchase (kBtu)`, `Water Use (All Water Sources) (kgal)`,"Total GHG Emissions (Metric Tons CO2e)", `Data` ) %>%
  data.frame() -> L84_2017

colnames(L84_2017) <- c("id",  "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "GHG", "Data")

L84_2017[c(7,12:21)] <- apply(L84_2017[c(7,12:21)], 2, as.numeric )
L84_2017[is.na(L84_2017)] <-0
L84_2017$Type <- as.factor(L84_2017$Type)
L84_2017 <- L84_2017 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect)) %>%
  mutate(EUI = T.Energy/GSF) %>%
  relocate(T.Energy, .after = Address) %>% 
  relocate(EUI, .after = T.Energy) %>% 
  mutate("Type" = fct_lump(Type, n=T, w = T.Energy))  %>% 
  arrange(id, T.Energy) 

# Remove duplicates 
L84_2017 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0 ) %>% 
  filter(GSF > 25000) %>% 
  filter(EUI <500 ) %>% 
  filter(EUI > 5) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2017


# Consolidate BBL's 
L84_2017$BBL <- gsub("-", "", L84_2017$BBL)
L84_2017$BBL <- gsub("/", "", L84_2017$BBL)
L84_2017$BBL <- gsub(",", ";", L84_2017$BBL)
strsplit(L84_2017$BBL, ';', fixed=T) -> L84_2017$BBL
L84_2017$BBL <- L84_2017$BBL %>% as.character(L84_2017$BBL) 

# add tags for small, med-sized and large properties. 

L84_2017 <- L84_2017 %>% 
  mutate("SizeBin" = cut(L84_2017$GSF, breaks = c(0, 25000, 50000, 500000,10000000), include.lowest = TRUE, labels = c("Small", "MidSized", "Large", "Large"), right = TRUE)) %>% 
  relocate(SizeBin, .after = GSF)

L84_2017[c(7,12,14)] <- apply(L84_2017[c(7,12,14)], 2, as.numeric )

L84_2018 <- read_csv("data/Energy_and_Water_Data_Disclosure_for_Local_Law_84_2019__Data_for_Calendar_Year_2018_.csv", col_names = TRUE, na = "NA" )

L84_2018 %>% mutate(Data = "2018") %>% 
  select( `Property Id`, `Property Name`, `NYC Borough, Block and Lot (BBL)`, `Address 1`, `Postcode`, `City`, `Property GFA - Self-Reported (ft²)`, `Primary Property Type - Self Selected`, `Year Built`, `Number of Buildings`,`Fuel Oil #1 Use (kBtu)`, `Fuel Oil #2 Use (kBtu)`, `Fuel Oil #4 Use (kBtu)`, `Fuel Oil #5 & 6 Use (kBtu)`, `Diesel #2 Use (kBtu)`, `District Steam Use (kBtu)`, `Natural Gas Use (kBtu)`, `Electricity Use - Grid Purchase (kBtu)`, `Water Use (All Water Sources) (kgal)`, "Total GHG Emissions (Metric Tons CO2e)", `Data` ) %>%
  data.frame() -> L84_2018

colnames(L84_2018) <- c("id", "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "GHG", "Data")


L84_2018[c(7,11:21)] <- apply(L84_2018[c(7,11:21)], 2, as.numeric )
L84_2018[is.na(L84_2018)] <-0
L84_2018$Type <- as.factor(L84_2018$Type)
L84_2018 <- L84_2018 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect)) %>%
  mutate(EUI = T.Energy/GSF) %>%
  relocate(T.Energy, .after = Address) %>% 
  relocate(EUI, .after = T.Energy) %>% 
  mutate("Type" = fct_lump(Type, n=T, w = T.Energy))  %>% 
  arrange(id, T.Energy) 


# Remove duplicates 
L84_2018 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0 ) %>% 
  filter(GSF > 25000) %>% 
  filter(EUI <500 ) %>% 
  filter(EUI > 5) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2018


# Consolidate BBL's 
L84_2018$BBL <- gsub("-", "", L84_2018$BBL)
L84_2018$BBL <- gsub("/", "", L84_2018$BBL)
L84_2018$BBL <- gsub(",", ";", L84_2018$BBL)
strsplit(L84_2018$BBL, ';', fixed=T) -> L84_2018$BBL
L84_2018$BBL <- L84_2018$BBL %>% as.character(L84_2018$BBL) 

# add tags for small, med-sized and large properties. 

L84_2018 <- L84_2018 %>% 
  mutate("SizeBin" = cut(L84_2018$GSF, breaks = c(0, 25000, 50000, 500000,10000000), include.lowest = TRUE, labels = c("Small", "MidSized", "Large", "Large"), right = TRUE)) %>% 
  relocate(SizeBin, .after = GSF)

L84_2018[c(7,12,14)] <- apply(L84_2018[c(7,12,14)], 2, as.numeric )


L84_2019 <- read_csv("data/Energy_and_Water_Data_Disclosure_for_Local_Law_84_2020__Data_for_Calendar_Year_2019_.csv", col_names = TRUE, na = "NA" )

L84_2019 %>% mutate(Data = "2019") %>% 
  select(`Property Id`, `Property Name`, `NYC Borough, Block and Lot (BBL)`, `Address 1`, `Postcode`, `City`, `Property GFA - Self-Reported (ft²)`, `Primary Property Type - Self Selected`, `Year Built`, `Number of Buildings`,`Fuel Oil #1 Use (kBtu)`, `Fuel Oil #2 Use (kBtu)`, `Fuel Oil #4 Use (kBtu)`, `Fuel Oil #5 & 6 Use (kBtu)`, `Diesel #2 Use (kBtu)`, `District Steam Use (kBtu)`, `Natural Gas Use (kBtu)`, `Electricity Use - Grid Purchase (kBtu)`, `Water Use (All Water Sources) (kgal)`, "Total GHG Emissions (Metric Tons CO2e)", `Data` ) %>%
  data.frame() -> L84_2019

colnames(L84_2019) <- c("id", "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "GHG", "Data")

L84_2019[c(7,11:21)] <- apply(L84_2019[c(7,11:21)], 2, as.numeric )
L84_2019[is.na(L84_2019)] <-0
L84_2019$Type <- as.factor(L84_2019$Type)
L84_2019 <- L84_2019 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect)) %>%
  mutate(EUI = T.Energy/GSF) %>%
  relocate(T.Energy, .after = Address) %>% 
  relocate(EUI, .after = T.Energy) %>% 
  mutate("Type" = fct_lump(Type, n=T, w = T.Energy))  %>% 
  arrange(id, T.Energy) 


# Remove duplicates 
L84_2019 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0 ) %>% 
  filter(GSF > 25000) %>% 
  filter(EUI <500 ) %>% 
  filter(EUI > 5) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2019


# Consolidate BBL's 
L84_2019$BBL <- gsub("-", "", L84_2019$BBL)
L84_2019$BBL <- gsub("/", "", L84_2019$BBL)
L84_2019$BBL <- gsub(",", ";", L84_2019$BBL)
strsplit(L84_2019$BBL, ';', fixed=T) -> L84_2019$BBL
L84_2019$BBL <- L84_2019$BBL %>% as.character(L84_2019$BBL) 

# add tags for small, med-sized and large properties. 

L84_2019 <- L84_2019 %>% 
  mutate("SizeBin" = cut(L84_2019$GSF, breaks = c(0, 25000, 50000, 500000,10000000), include.lowest = TRUE, labels = c("Small", "MidSized", "Large", "Large"), right = TRUE)) %>% 
  relocate(SizeBin, .after = GSF)

L84_2019[c(7,12,14)] <- apply(L84_2019[c(7,12,14)], 2, as.numeric )


L84_2020 <- read_csv("data/Energy_and_Water_Data_Disclosure_for_Local_Law_84_2021__Data_for_Calendar_Year_2020_.csv", col_names = TRUE, na = "NA" )

L84_2020 %>% mutate(Data = "2020") %>% 
  select(`Property Id`, `Property Name`, `NYC Borough, Block and Lot (BBL)`, `Address 1`, `Postcode`, `City`, `Property GFA - Self-Reported (ft²)`, `Primary Property Type - Self Selected`, `Year Built`, `Number of Buildings`,`Fuel Oil #1 Use (kBtu)`, `Fuel Oil #2 Use (kBtu)`, `Fuel Oil #4 Use (kBtu)`, `Fuel Oil #5 & 6 Use (kBtu)`, `Diesel #2 Use (kBtu)`, `District Steam Use (kBtu)`, `Natural Gas Use (kBtu)`, `Electricity Use - Grid Purchase (kBtu)`, `Water Use (All Water Sources) (kgal)`, "Total GHG Emissions (Metric Tons CO2e)", `Data` ) %>%
  data.frame() -> L84_2020

colnames(L84_2020) <- c("id", "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "GHG", "Data")

L84_2020[11:21] <- apply(L84_2020[11:21], 2, as.numeric )
L84_2020[is.na(L84_2020)] <-0
L84_2020$Type <- as.factor(L84_2020$Type)
L84_2020 <- L84_2020 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect)) %>%
  mutate(EUI = T.Energy/GSF) %>%
  relocate(T.Energy, .after = Address) %>% 
  relocate(EUI, .after = T.Energy) %>% 
  mutate("Type" = fct_lump(Type, n=T, w = T.Energy))  %>% 
  arrange(id, T.Energy) 

# Remove duplicates and outliers 

L84_2020 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0 ) %>% 
  filter(GSF > 25000) %>% 
  filter(EUI <500 ) %>% 
  filter(EUI > 5) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2020


# Consolidate BBL's 
L84_2020$BBL <- gsub("-", "", L84_2020$BBL)
L84_2020$BBL <- gsub("/", "", L84_2020$BBL)
L84_2020$BBL <- gsub(",", ";", L84_2020$BBL)
strsplit(L84_2020$BBL, ';', fixed=T) -> L84_2020$BBL
L84_2020$BBL <- L84_2020$BBL %>% as.character(L84_2020$BBL) 


# add tags for small, med-sized and large properties. 

L84_2020 <- L84_2020 %>% 
  mutate("SizeBin" = cut(L84_2020$GSF, breaks = c(0, 25000, 50000, 500000,10000000), include.lowest = TRUE, labels = c("Small", "MidSized", "Large", "Large"), right = TRUE)) %>% 
  relocate(SizeBin, .after = GSF)


AllData <- SameStore <- bind_rows(L84_2015, L84_2016, L84_2017, L84_2018, L84_2019, L84_2020)




















#Create a vector containing unique same store properties by property id

L84_2020 %>% 
  inner_join(L84_2019, by = "BBL") %>% 
  inner_join(L84_2018, by = "BBL") %>% 
  inner_join(L84_2017, by = "BBL") %>% 
  inner_join(L84_2016, by = "BBL") %>%
  inner_join(L84_2015, by = "BBL") %>% 
  select(BBL) %>% 
  pull(BBL) -> AllYearsID


# create data frame of just samestore properties 

L84_2015 %>% 
  filter(BBL %in% AllYearsID) -> temp15
L84_2016 %>% 
  filter(BBL %in% AllYearsID) -> temp16
L84_2017 %>% 
  filter(BBL %in% AllYearsID) -> temp17
L84_2018 %>% 
  filter(BBL %in% AllYearsID) -> temp18
L84_2019 %>% 
  filter(BBL %in% AllYearsID) -> temp19
L84_2020 %>% 
  filter(BBL %in% AllYearsID) -> temp20

SameStore <- bind_rows(temp15, temp16, temp17,temp18, temp19, temp20) 
                      
remove(temp15, temp16, temp17, temp18, temp19, temp20)



# Add carbon parameters to the dataframes 

EmissionLimits <- read_excel("data/LL97Parameters .xlsx", sheet = "EmissionsLimits", col_names = TRUE, na = "NA",col_types = c("numeric", "text", "numeric", "text", "numeric") ) %>% drop_na()

CarbonFactors <- read_excel("data/LL97Parameters .xlsx", sheet = "CarbonFactors", col_names = TRUE, na = "NA",col_types = c("text", "numeric", "text", "numeric") ) %>% drop_na()


SameStore <- SameStore %>% 
  mutate("E_2024_tCO2e" = Elect * 	0.000288962/3.214) %>%
  mutate("E_2030_tCO2e" = Elect * 	0.000288962/3.214) %>%
  mutate("G_2024_tCO2e" = N.Gas * 	0.000053110) %>%
  mutate("G_2030_tCO2e" = N.Gas * 	0.000053110) %>%
  mutate("S_2024_tCO2e" = Steam * 	0.000044930) %>%
  mutate("S_2030_tCO2e" = Steam * 	0.000044930) %>%
  mutate("O1_2024_tCO2e" = Oil1 * 	0.000074210) %>%
  mutate("O1_2030_tCO2e" = Oil1 * 	0.000074210) %>% 
  mutate("O2_2024_tCO2e" = Oil2 * 	0.000074210) %>%
  mutate("O2_2030_tCO2e" = Oil2 * 	0.000074210) %>% 
  mutate("O4_2024_tCO2e" = Oil4 * 	0.000075290) %>%
  mutate("O4_2030_tCO2e" = Oil4 * 	0.000075290) %>% 
  mutate("O56_2024_tCO2e" = Oil56 * 	0.000075290) %>%
  mutate("O56_2030_tCO2e" = Oil56 * 	0.000075290) %>% 
  mutate("D_2024_tCO2e" = Diesel * 	0.000075290) %>%
  mutate("D_2030_tCO2e" = Diesel * 	0.000075290) %>% 
  mutate("tCO2e_2024" = E_2024_tCO2e + G_2024_tCO2e + S_2024_tCO2e + O1_2024_tCO2e + O2_2024_tCO2e + O4_2024_tCO2e + O56_2024_tCO2e + D_2024_tCO2e) %>% 
   relocate(tCO2e_2024, .after = T.Energy) 


#Summarize Types of buildings 

Types <- SameStore %>%
  group_by(Type) %>%  
  summarise("Number" = sum(No.Buildings), "GSF" = sum(GSF), "T.Energy" = sum(T.Energy), "tCO2e_2024" = sum(tCO2e_2024))  %>% 
  mutate(GSF_1000xSF  = GSF/1000, T.Energy_MMbtu = T.Energy/1000) %>%
  arrange(desc(T.Energy_MMbtu)) 


#Calculate emissions limits per year for Office 

SameStore %>% 
  filter(Type == "Office") %>% 
  group_by(Data) %>% 
   summarise("Elect" = sum(Elect), "NGas" = sum(N.Gas), "Steam" = sum(Steam), GSF = sum(GSF)) %>% 
  mutate("EmmisionsLimit" = 0.00846 * GSF) -> Office_Emissions_Limits
OfficeEmmisions <- mean(Office_Emissions_Limits$EmmisionsLimit) 


# Tabulate total mid and large emissions attributed to buildings per UG report
CityEmissions_2019 <- 55100000

LL84Emissions_2019 <- sum(SameStore %>% filter(Data == 2019)%>% summarise(tCO2e_2024))

LL84Emissions_2019/CityEmissions_2019


```
Discussion on data import.
I imported years 2015 through 2020 from the NYC OpenData. To gain consistancy I filtered out sites that are not reprensented in all years based on thier associated Borough-Bloack-Lot (BBL) codes.  `r length(L84_2019$BBL)`


Discussion on elimination of outliers and effect on types. 
Changes to outliers strategy.
Basic statistics of cleaned data 


```{r Tables, echo=FALSE, message=FALSE, warning=FALSE}

#TABLE Number of Types in each submission year

data.frame("Description" = "Types", 'Yr 2015' = length(levels( L84_2015$Type )), 'Yr 2016'= length(levels(L84_2016$Type)), 'Yr 2017' = length(levels( L84_2017$Type )), 'Yr 2018'= length(levels(L84_2018$Type)),'Yr 2019' = length(levels( L84_2019$Type )), 'Yr 2020'= length(levels(L84_2020$Type))) %>% 
  kable() %>% 
  kable_styling() 



# TABLE Number of Buildings in each Use Type by Submission

AllData %>% 
  group_by(Data, Type) %>% 
  summarise( "No.Buildings" = sum(No.Buildings)) %>% 
  spread(key = Data, value = No.Buildings) %>% 
  kable(digits = 3, 
        col.names = c("Building Use Type", "2015", "2016", "2017", "2018", "2019", "2020"),
        align = "lcccccc", 
        caption = "<center><strong><strong>Number of Buildings in each Use Type by Submission Year</strong></strong></center>",
        label = "Table 1", 
        format.args = list(decimal.mark = ".", big.mark = ","),
        escape = FALSE) %>% 
  kable_styling()



# TABLE Number of Buildings in the top use Types by Submission

AllData %>% 
  mutate("Type" = fct_lump(Type, n=10, w = T.Energy)) %>% 
  group_by(Data, Type) %>% 
  summarise( "No.Buildings" = sum(No.Buildings)) %>% 
  spread(key = Data, value = No.Buildings) %>% 
  kable(digits = 3, 
        col.names = c("Building Use Type", "2015", "2016", "2017", "2018", "2019", "2020"),
        align = "lcccccc", 
        caption = "<center><strong><strong>Number of Buildings in the top use Types by Submission Year</strong></strong></center>",
        label = "Table 1", 
        format.args = list(decimal.mark = ".", big.mark = ","),
        escape = FALSE) %>% 
  kable_styling()

#TABLE GSF of Buildings in each use Type by Submission Year

AllData %>% 
  mutate("Type" = fct_lump(Type, n=10, w = T.Energy)) %>% 
  group_by(Data, Type) %>% 
  summarise( "T.GSF" = sum(GSF)) %>% 
  spread(key = Data, value = T.GSF) %>% 
  kable(digits = 3, 
        col.names = c("Building Use Type", "2015", "2016", "2017", "2018", "2019", "2020"),
        align = "lcccccc", 
        caption = "<center><strong><strong>GSF of Buildings in each use Type by Submission Year</strong></strong></center>",
        label = "Table 1", 
        format.args = list(decimal.mark = ".", big.mark = ","),
        escape = FALSE) %>% 
  kable_styling()


# TABLE Total Gross SF by submission year. 
AllData %>% 
  mutate("Type" = fct_lump(Type, n=10, w = T.Energy)) %>% 
  group_by(Data, Type) %>% 
  summarise( "T.GSF" = sum(GSF)) %>% 
  spread(key = Data, value = T.GSF) 


# Look at sf of submission by type by year

# Look at sf of submission by type by year
L84_2015 %>% 
  select(Type, T.Energy, GSF) %>% 
  group_by(Type) %>% 
  summarise(EnergyS = sum(T.Energy), GSF = sum(GSF)) %>% 
  mutate("EnergyP" = EnergyS/sum(EnergyS)) %>% 
  mutate(across(where(is.numeric), ~ round(., digits = 3))) %>%
    arrange(desc(EnergyP))  %>% 
    select(Type, EnergyS, EnergyP, GSF) %>% 
  kable(format = "html", digits = 9, col.names = c("Use Type", "T.Energy", "%", "GSF")) %>%     
  kable_styling(full_width = FALSE)

L84_2016 %>% 
  select(Type, T.Energy, GSF) %>% 
  group_by(Type) %>% 
  summarise(T.Energy = sum(T.Energy), GSF = sum(GSF)) %>% 
  mutate(across(where(is.numeric), ~ round(., digits = 3))) %>%
    arrange(desc(T.Energy))  %>% 
  kable(format = "html", digits = 9, col.names = c("Use Type", "T.Energy", "GSF")) %>%     
  kable_styling(full_width = FALSE)

L84_2020 %>% 
  select(Type, GSF) %>% 
  group_by(Type) %>% 
  summarise(GSF = sum(GSF)) %>% 
  mutate(across(where(is.numeric), ~ round(., digits = 3))) %>%
    arrange(desc(GSF))  %>% 
  kable(format = "html", digits = 6, col.names = c("Use Type", "GSF")) %>%     
  kable_styling(full_width = FALSE)

```













```{r Tables, echo=FALSE, message=FALSE, warning=FALSE}


#Table of buildings in data set 

Types_no_outliers %>% 
    select(SizeBin, Type, Number, GSF, tCO2e_2024) %>% 
    group_by(SizeBin, Type) %>% 
    summarise(Number = sum(Number), GSF = sum(GSF),MMtCO2e = sum(tCO2e_2024)/1000000) %>% 
    mutate(across(where(is.numeric), signif, 3)) %>%  
    arrange(desc(MMtCO2e)) %>% 
    kable(format = "html", digits = 6, col.names = c("Size Bin", "Use Type", "Quantity", "GSF", "tCO2e")) %>%     
  kable_styling(full_width = FALSE)

Types_no_outliers %>% 
    select(SizeBin, Type, Number, GSF, tCO2e_2024) %>% 
    group_by(SizeBin, Type) %>% 
    summarise(Number = sum(Number), GSF = sum(GSF),MMtCO2e = sum(tCO2e_2024)/1000000) %>% 
    mutate(Type = fct_reorder(Type, MMtCO2e, sum)) %>%
    mutate(across(where(is.numeric), signif, 3)) %>%  
  ggplot( aes(Type, MMtCO2e, fill = SizeBin)) +
  geom_col(position = "stack")

########################################################################
L84_2019 %>% 
    mutate("SizeBin" = cut(L84_2019$GSF, breaks = c(0, 25000, 50000, 500000,10000000), include.lowest = TRUE, labels = c("Small", "MidSized", "Large", "Large"), right = TRUE)) %>% 
  relocate(SizeBin, .after = GSF) %>% 
    select(SizeBin, Type, GSF, GHG) %>% 
    group_by(SizeBin, Type) %>% 
    summarise(GSF = sum(GSF),MMtCO2e = sum(GHG)/1000000) %>% 
    mutate(Type = fct_reorder(Type, MMtCO2e, sum)) %>%
    mutate(across(where(is.numeric), signif, 3)) %>%  
  ggplot( aes(Type, MMtCO2e, fill = SizeBin)) +
  geom_col(position = "stack")
########################################################################


L84_2019 %>% 
    select( `Primary Property Type - Self Selected`) %>% 
    group_by(`Primary Property Type - Self Selected`) %>% 
    distinct() %>% 
    kable(format = "html", digits = 6, col.names = "Use Type")



```




```{r Benchmark EMissions and Energy Trends, echo=FALSE, message=FALSE, warning=FALSE}

BMEmission <- SameStore_no_outliers %>% 
  select(Type, Data, T.Energy, tCO2e_2024, GHG) %>%
  group_by(Type, Data) %>% 
  summarise( T.Energy_kBTU = sum(T.Energy), Emissions_tCO2e = sum(tCO2e_2024), GHG = sum(GHG))

BMEmission0 <- BMEmission %>% 
  filter(Data == 2015) 

BMEmission <- left_join(BMEmission, BMEmission0, by = "Type")

par(mfcol = c(2,1))
BMEmission %>% 
  mutate(T.Energy_kBTU = ( T.Energy_kBTU.x - T.Energy_kBTU.y )/T.Energy_kBTU.y )  %>% 
  mutate(Emissions_tCO2e = ( Emissions_tCO2e.x - Emissions_tCO2e.y )/ Emissions_tCO2e.y ) %>% 
  select(Type, Data.x, T.Energy_kBTU, Emissions_tCO2e) %>% 
  rename( c("Data" = "Data.x")) %>% 
  ggplot(aes(Data, T.Energy_kBTU, col = Type)) +
  geom_line() +
  theme_classic()

BMEmission %>% 
  mutate(T.Energy_kBTU = ( T.Energy_kBTU.x - T.Energy_kBTU.y )/T.Energy_kBTU.y )  %>% 
  mutate(Emissions_tCO2e = ( Emissions_tCO2e.x - Emissions_tCO2e.y )/ Emissions_tCO2e.y ) %>% 
  select(Type, Data.x, T.Energy_kBTU, Emissions_tCO2e) %>% 
  rename( c("Data" = "Data.x")) %>% 
  ggplot(aes(Data, Emissions_tCO2e, col = Type)) +
  geom_line() +
  theme_classic()

# Using carbon from Portfolio Manager
BMEmission %>% 
  mutate(T.Energy_kBTU = ( T.Energy_kBTU.x - T.Energy_kBTU.y )/T.Energy_kBTU.y )  %>% 
  mutate(Emissions_tCO2e = ( Emissions_tCO2e.x - Emissions_tCO2e.y )/ Emissions_tCO2e.y ) %>%
  mutate(GHG = ( GHG.x - GHG.y )/ GHG.y ) %>% 
  select(Type, Data.x, T.Energy_kBTU, Emissions_tCO2e, GHG) %>% 
  rename( c("Data" = "Data.x"))   %>%  
  ggplot(aes(Data, GHG, col = Type)) +
  geom_line() +
  theme_classic()



```
#Rank by number of properties
SameStore %>%
  count(Type) %>%
  mutate(Type = fct_reorder(Type, n)) %>%
  ggplot(aes(Type, n)) +
  geom_col() +
  labs(y = "Number of Buildings", x = "Use Types", title = "Counts of Buildings submitted for 2021 period") + 
  coord_flip() 

SameStore_no_outliers %>% 
  group_by(Type) %>% 
  summarise("Elect" = (sum(Elect)/6), "NGas" = (sum(N.Gas)/6), "Steam" = (sum(Steam))/6) %>% 
  gather(key = "Energy", value = "Utilities", Elect, Steam, NGas, -Type, factor_key = TRUE) %>% 
  ggplot(aes(Type, Utilities, fill = Energy)) +
  geom_col(position = "stack") +
  labs(title = "Energy Use by Building Type"  )   


SameStore_no_outliers %>%
  filter(Data == 2019) %>% 
  group_by(Type) %>% 
  summarise("Elect" = sum(Elect), "NGas" = sum(N.Gas), "Steam" = sum(Steam)) %>% 
  gather(key = "Energy", value = "Utilities", Elect, Steam, NGas, -Type, factor_key = TRUE) %>% 
  ggplot(aes(Type, Utilities, fill = Energy)) +
  geom_col(position = "stack")+
  labs(title = "Energy Use by Building Type using 2019 data only")  
 

SameStore_no_outliers %>%
  filter(Data == 2020) %>% 
  group_by(Type) %>% 
  summarise("Elect" = sum(Elect), "NGas" = sum(N.Gas), "Steam" = sum(Steam)) %>% 
  gather(key = "Energy", value = "Utilities", Elect, Steam, NGas, -Type, factor_key = TRUE) %>% 
  ggplot(aes(Type, Utilities, fill = Energy)) +
  geom_col(position = "stack")+
  labs(title = "Energy Use by Building Type using 2020 data only")  
  

SameStore_no_outliers %>% 
  filter(Type == "Office") %>% 
  ggplot(aes(x = Built, y = EUI, color = Data)) +
  geom_point() +
  geom_smooth() +
  facet_grid(Data ~.) +
  geom_vline(aes(xintercept = 1930), color = "red") +
  labs( title = "Office EUI by build year and LL84 datasets")

SameStore_no_outliers %>% 
  filter(Type == "Office") %>% 
  group_by(Built) %>% 
  summarise("N.Build" = sum(No.Buildings), Data) %>% 
  ggplot(aes(x = Built, y = N.Build)) +
  geom_point() +
  geom_smooth() +
  geom_vline(aes(xintercept = 1942)) +
  geom_vline(aes(xintercept = 1945)) +
  geom_vline(aes(xintercept = 1930, color = "red"))


SameStore_no_outliers %>% 
  filter(Type == "Office") %>% 
  select(Data, Type, Elect, Steam, N.Gas, GSF) %>% 
  gather(key = "Energy", value = "Utilities", Elect, Steam, N.Gas, -Data, factor_key = TRUE) %>%
  left_join(CarbonFactors, by = "Energy")  %>% 
  mutate_at(vars(matches("Factor")), ~ifelse(Energy == "Elect", 0.000288962/3.214, .)) %>% 
  mutate(carbon_tCO2e = Utilities * Factor)  %>% 
  ggplot(aes(Data, carbon_tCO2e, fill = Energy)) +
  geom_col(position = "stack")+
  labs(title = "Carbon by Building Type using 2019 data only") 
  




SameStore_no_outliers %>% 
  filter(Type == "Office") %>% 
  select(Data, Elect, Steam, N.Gas, GSF) %>% 
  gather(key = "Energy", value = "Utilities", Elect, Steam, N.Gas, -Data, factor_key = TRUE) %>%
  left_join(CarbonFactors, by = "Energy") %>% 
  mutate_at(vars(matches("Factor")), ~ifelse(Energy == "Elect", 0.000288962/3.214, .)) %>% 
  mutate(carbon_tCO2e = Utilities * Factor) %>% 
  filter(Data == 2020) %>% 
  mutate("CUI" = carbon_tCO2e / GSF) %>% 
  ggplot( aes(GSF, carbon_tCO2e)) +
  geom_point() + 
  geom_abline(aes(intercept = 0, slope = 0.00846)) +
  geom_abline(aes(intercept = 0, slope = 0.00453, color = "red")) +
  labs(title = "Office Carbon by GSF", x = "GSF", y = "tCO2e") 



SameStore_no_outliers %>% 
  filter(Type == "Office") %>% 
  group_by(Data) %>% 
  summarise("Elect" = sum(Elect), "N.Gas" = sum(N.Gas), "Steam" = sum(Steam), GSF = sum(GSF)) %>% 
  gather(key = "Energy", value = "Utilities", Elect, Steam, N.Gas, -Data, factor_key = TRUE) %>% 
  left_join(CarbonFactors, by = "Energy") %>% 
  mutate_at(vars(matches("Factor")), ~ifelse(Energy == "Elect", 0.000288962/3.214, .)) %>% 
  mutate(carbon_tCO2e = Utilities * Factor)   %>% 
  ggplot(aes(Data, carbon_tCO2e, fill = Energy)) +
  geom_col(position = "stack") +
  geom_hline(aes(yintercept = OfficeEmmisions)) +
  labs(title = "1 Office Carbon by year by Scope", x = "Submission Yeaer", y = "tCO2e")  





SameStore_no_outliers %>% 
  filter(Type == "Housing") %>% 
  group_by(Data) %>% 
  summarise("Elect" = sum(Elect), "NGas" = sum(N.Gas), "Steam" = sum(Steam)) %>% 
  gather(key = "Energy", value = "Utilities", Elect, Steam, NGas, -Data, factor_key = TRUE) %>% 
  left_join(CarbonFactors, by = "Energy") %>% 
  mutate_at(vars(matches("Factor")), ~ifelse(Energy == "Elect", 0.000288962/3.214, .)) %>% 
  mutate(carbon_tCO2e = Utilities * Factor)  %>% 
  ggplot(aes(Data, carbon_tCO2e, fill = Energy)) +
  geom_col(position = "stack")+
  labs(title = "Multifamily Housing Carbon by year by Scope", x = "Submission Year")  



SameStore_no_outliers %>%
  filter(Data == 2019) %>% 
  group_by(Type) %>% 
  summarise("Elect" = sum(Elect), "NGas" = sum(N.Gas), "Steam" = sum(Steam)) %>% 
  gather(key = "Energy", value = "Utilities", Elect, Steam, NGas, -Type, factor_key = TRUE) %>% 
  left_join(CarbonFactors, by = "Energy") %>% 
  mutate_at(vars(matches("Factor")), ~ifelse(Energy == "Elect", 0.000288962/3.214, .)) %>% 
  mutate(carbon_tCO2e = Utilities * Factor)  %>% 
  ggplot(aes(Type, carbon_tCO2e, fill = Energy)) +
  geom_col(position = "stack")+
  labs(title = "Carbon by Building Type using 2019 data only")  


```

```{r Charts, echo=FALSE, message=FALSE, warning=FALSE}

SameStore_no_outliers %>%
  filter(Data == 2019 & Type == "Office") %>% 
  select(Name,EUI,Built ) %>% 
  ggplot( aes(EUI)) +
  geom_density()
  

```
