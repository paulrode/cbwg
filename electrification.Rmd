---
title: "Commercial Building Electrification at Scale"
output: 
  html_document: default 

---

```{r, echo="FALSE", include=FALSE, message=FALSE}

###############################################################################
#                             Set up environment                                #
###############################################################################

my_packages <- c("tidyverse", "lubridate", "fable", "tsibbledata", "ggplot2", "forecast", "tseries", "rio", "zoo", "readxl", "tsibbledata", "knitr", "kablExtra") 
lapply(my_packages, require, character.only = TRUE)

#Choose one working site:
 place <- "Home"
# place <-  "work"

#Set proper working Dir 
if (place == "Home"){setwd("C:/Users/paulr/Documents/R/cbwg")} else
{setwd("C:/Users/prode/Documents/R/cbwg")}

# Check for data directory and if one is not present then make it
if (!file.exists("data")) {
  dir.create("data")}

rm(place, my_packages )
  
```

The goal with this data project is to use the LL84 benchmarking to
identify the thermal potential in each of the building typologies. 1.
Identify the kBTU's of gas, oil and district steam used (thermal fuel)
in the commercial stock. 2. Allocate the thermal fuel among building
typologies. 3. Show ranking of typologies by sf and thermal fule volumn.
3. Show steam in manhattan as a breakout.

```{r echo="FALSE", message=FALSE, include=FALSE}

# Read in data

L84_2017 <- read_excel("data/2017_nyc_benchmarking.xlsx", sheet = "Information and Metrics", col_names = TRUE, na = "NA"  ) %>%   
  mutate(Data = "2017") %>%
  data.frame() 
L84_2016 <- read_excel("data/2016_nyc_benchmarking.xlsx", sheet = "Information and Metrics", col_names = TRUE, na = "NA"  ) %>%   
  mutate(Data = "2016")


L84_2017 %>%
  select(Property.Id, 
         NYC.Building.Identification.Number..BIN., 
         Address.1..self.reported., Borough, Property.Name, 
         `Self.Reported.Gross.Floor.Area..ft².`, 
         Primary.Property.Type...Self.Selected, 
         Year.Built, 
         Number.of.Buildings, 
         `Site.EUI..kBtu.ft².`,
         `Source.EUI..kBtu.ft².`,
         Fuel.Oil..1.Use..kBtu., 
         Fuel.Oil..2.Use..kBtu., 
         Fuel.Oil..4.Use..kBtu., 
         Fuel.Oil..5...6.Use..kBtu., 
         Diesel..2.Use..kBtu.,
         District.Steam.Use..kBtu.,
         Natural.Gas.Use..kBtu., 
         Electricity.Use...Grid.Purchase..kBtu., 
         Water.Use..All.Water.Sources...kgal., 
         Data) -> L84_a

L84_2016 %>% 
  select(`Property Id`, 
         `NYC Building Identification Number (BIN)`,
         `Address 1 (self-reported)`, Borough, `Property Name`,
         `Largest Property Use Type - Gross Floor Area (ft²)`,
         `2nd Largest Property Use - Gross Floor Area (ft²)`,
         `3rd Largest Property Use Type - Gross Floor Area (ft²)`,
         `Primary Property Type - Self Selected`,
         `Year Built`,
         `Number of Buildings - Self-reported`,
         `Site EUI (kBtu/ft²)`,
         `Source EUI (kBtu/ft²)`,
         `Fuel Oil #1 Use (kBtu)`,
         `Fuel Oil #2 Use (kBtu)`,
         `Fuel Oil #4 Use (kBtu)`,
         `Fuel Oil #5 & 6 Use (kBtu)`,
         `Diesel #2 Use (kBtu)`,
         `District Steam Use (kBtu)`,
         `Natural Gas Use (kBtu)`,
         `Electricity Use - Grid Purchase (kBtu)`,
         `Water Use (All Water Sources) (kgal)`,
         Data ) -> L84_b
L84_b$`Largest Property Use Type - Gross Floor Area (ft²)` <- as.numeric(L84_b$`Largest Property Use Type - Gross Floor Area (ft²)`)
L84_b$`2nd Largest Property Use - Gross Floor Area (ft²)` <- as.numeric(L84_b$`2nd Largest Property Use - Gross Floor Area (ft²)`)
L84_b$`3rd Largest Property Use Type - Gross Floor Area (ft²)`<-as.numeric(L84_b$`3rd Largest Property Use Type - Gross Floor Area (ft²)`)
L84_b$`Self.Reported.Gross.Floor.Area..ft².` <- L84_b$`Largest Property Use Type - Gross Floor Area (ft²)` +  L84_b$`2nd Largest Property Use - Gross Floor Area (ft²)` + L84_b$`3rd Largest Property Use Type - Gross Floor Area (ft²)`
                             



#Add GSF bins to identify where bulk of sf is by GSF ranges 50,000 up to over 500k.
c <- c("0 to 50,000", "50,000 to 100,000", "100,000 to 500,000", "500,000 to 1,000,000", "over 1,000,000")
L84_2017$bins <- cut(L84_2017$`Self.Reported.Gross.Floor.Area..ft².`, breaks = c(0,50000, 100000, 500000, 1000000, 9000000), dig.lab = 7 , ordered_result = TRUE, labels = c ) 
d <- c("pre 1942", "1942 to 1980", "1980 to 2000")
L84_2017$Year.Range <- cut(L84_2017$Year.Built, breaks = c(0, 1942, 1980, 2021),dig.lab = 4, labels = d)
remove(c,d) #clean up environment


# Add total thermal which is the sum of all thermal fuels. 

L84_2017 %>% rowwise() %>%  mutate("Total.Thermal (kBTU)" = sum(Fuel.Oil..1.Use..kBtu., Fuel.Oil..2.Use..kBtu., Fuel.Oil..4.Use..kBtu. , Fuel.Oil..5...6.Use..kBtu.,  Diesel..2.Use..kBtu. , Propane.Use..kBtu. , District.Steam.Use..kBtu. , District.Hot.Water.Use..kBtu. + District.Chilled.Water.Use..kBtu. , Natural.Gas.Use..kBtu., na.rm = TRUE) ) -> L84_2017

# Calculate Site EUI to compare to vales in the data frame
L84_2017 %>% mutate("EUI" = ifelse(is.na(Electricity.Use...Grid.Purchase..kBtu.), (`Total.Thermal (kBTU)`)/ `Self.Reported.Gross.Floor.Area..ft².`, (Electricity.Use...Grid.Purchase..kBtu. + `Total.Thermal (kBTU)`)/ `Self.Reported.Gross.Floor.Area..ft².`)) %>%
  mutate("Electric EUI" = ifelse(is.na(Electricity.Use...Grid.Purchase..kBtu.), 0, Electricity.Use...Grid.Purchase..kBtu./`Self.Reported.Gross.Floor.Area..ft².`), "Thermal EUI" = `Total.Thermal (kBTU)`/`Self.Reported.Gross.Floor.Area..ft².`, "EUI (Thermal/Total)" = `Thermal EUI`/EUI, "Site/Source EUI" = `Site.EUI..kBtu.ft².` / `Source.EUI..kBtu.ft².`) -> L84_2017

# Remove bad data using following rules: 
  #(1) Rows with 0 buildings. 
  #(2) remove rows with EUI = 0 
  #(3) remove bad 65 Broadway Manhattan and 290 Wallabout Street Brooklyn - bad data 
  #(4) remove buildings with year built < 1800
  
L84_2017 %>% filter(`Self.Reported.Gross.Floor.Area..ft².` >= 25000) %>%
  drop_na(`Site.EUI..kBtu.ft².`) %>%
  filter(Property.Name != "65 broadway llc") %>%
  filter(Property.Name != "North Shore Towers") %>%
  filter(Property.Name != "Museum of Modern Art") %>%
  filter(Property.Name != "290 Wallabout St") %>%
  filter(Year.Built > 1800) -> L84_2017

load( "./data/typetable.RData")
colnames(type.table) <- c("Primary.Property.Type...Self.Selected", "Property.Type")
L84_2017 <- left_join(L84_2017, type.table, by = "Primary.Property.Type...Self.Selected")
L84_2017$Property.Type <- as.factor(L84_2017$Property.Type)

L84_2017 %>%
  filter(Data != "Multi-BBL") %>%
  summarise("NGas.(kBtu)" = sum(Natural.Gas.Use..kBtu. , na.rm = TRUE ), "Oil.No1" = sum(Fuel.Oil..1.Use..kBtu., na.rm = TRUE), "Oil.No2" = sum(Fuel.Oil..2.Use..kBtu., na.rm = TRUE), "Oil,No4" = sum(Fuel.Oil..4.Use..kBtu., na.rm = TRUE), "Oil.No5&6" = sum(Fuel.Oil..5...6.Use..kBtu., na.rm = TRUE), "Diesel.(kBtu)" = sum(Diesel..2.Use..kBtu., na.rm = TRUE), "Propane.(kBtu)" = sum(Propane.Use..kBtu., na.rm = TRUE), "Steam.(kBtu)" = sum(District.Steam.Use..kBtu., na.rm = TRUE), "Elect.(kBtu)" = sum(Electricity.Use...Grid.Purchase..kBtu., na.rm = TRUE)) -> Total.Energy
```

What is the total thermal energy as reported through the Benchamrking
Law, and how does that compair to Electrical energy used in the same
buildings.

Use the information file.

```{r, echo="TRUE", include= "TRUE", message=FALSE, results='markup'}

# Total Energy by Fuel Type
Total.Energy %>%
  gather(key = "Fuel.Source", value = "kBtu" ) %>%
  arrange(desc(kBtu))%>%
  mutate(Fuel.Source = factor(Fuel.Source, levels = unique(Fuel.Source))) %>% 
  ggplot(aes(x = Fuel.Source, y=kBtu, fill = Fuel.Source)) +
  geom_col() + theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  ggtitle("Total Energy by Fuel Type")
  ggsave(filename =  "Energy_by_Type.jpeg", device = "jpeg", scale = 1, width = 6, height = 4, bg = "grey")
  
# Make a box plot showing fule type statics in a box plot
L84_2017 %>%
  select(Fuel.Oil..1.Use..kBtu., Fuel.Oil..2.Use..kBtu., Fuel.Oil..4.Use..kBtu., Fuel.Oil..5...6.Use..kBtu., Diesel..2.Use..kBtu., Propane.Use..kBtu., District.Steam.Use..kBtu., Natural.Gas.Use..kBtu., Electricity.Use...Grid.Purchase..kBtu.) %>%
  gather(key = "Fuel.Source", value = "kBtu") %>%
  filter(Fuel.Source == "District.Steam.Use..kBtu.") %>%
  mutate(Fuel.Source = factor(Fuel.Source, levels = unique(Fuel.Source))) %>% 
  ggplot(aes(x = Fuel.Source, y=kBtu, fill = Fuel.Source) ) +
  geom_boxplot() + theme(axis.text.x = element_text(angle = 60, hjust = 1))
  
L84_2017 %>% select(Fuel.Oil..1.Use..kBtu., Fuel.Oil..2.Use..kBtu., Fuel.Oil..4.Use..kBtu., Fuel.Oil..5...6.Use..kBtu., Diesel..2.Use..kBtu., Propane.Use..kBtu., District.Steam.Use..kBtu., Natural.Gas.Use..kBtu., Electricity.Use...Grid.Purchase..kBtu.) %>%
  gather(key = "Fuel.Source", value = "kBtu") %>%
  filter(Fuel.Source == "District.Steam.Use..kBtu.") -> temp
summary(temp$kBtu)

  
Total.Energy%>%
  mutate("Total.Thermal.(kBtu)" = `NGas.(kBtu)`+ Oil.No1 + Oil.No2 + `Oil,No4` + `Oil.No5&6`+ `Diesel.(kBtu)`+ `Propane.(kBtu)`+ `Steam.(kBtu)`) %>%
  select(`Total.Thermal.(kBtu)`, `Elect.(kBtu)`) %>%
  gather(key = "Fuel.Source", value = "kBtu" ) %>% 
  arrange(desc(kBtu))%>%
  mutate(Fuel.Source = factor(Fuel.Source, levels = unique(Fuel.Source))) %>% 
  ggplot(aes(x = Fuel.Source, y=kBtu, fill = Fuel.Source) ) +
  geom_col() + theme(axis.text.x = element_text(angle = 60, hjust = 1))

L84_2017 %>% 
  ggplot(aes(x = `Site/Source EUI`)) +
  geom_density()

#Note how EUI ratio is lower for all electric buildings. 

L84_2017 %>%
  filter(`Total.Thermal (kBTU)`== 0) %>%
  ggplot(aes(x = `Site/Source EUI`)) +
  geom_density()

```

```{r, echo="FALSE", include=FALSE, message=FALSE}
#EUI 
L84_2017 %>% 
  filter(`Site.EUI..kBtu.ft².` < 500) %>%
  ggplot(aes( x = Property.Type, y = EUI, color = Property.Type)) +
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))

L84_2017 %>% 
  ggplot(aes(x = `EUI (Thermal/Total)`)) + 
  geom_density() +
  geom_vline(xintercept=mean(L84_2017$`EUI (Thermal/Total)` , na.rm = TRUE) ,color="blue", linetype="dashed", size=1)

#EUI by type and range
L84_2017 %>% filter(`Site.EUI..kBtu.ft².` < 500) %>%
  filter(Property.Type == "Office" | Property.Type == "Multifamily" ) %>%
  ggplot(aes( x = Year.Range, y = EUI, color = Property.Type, fill=Property.Type)) +
  geom_boxplot()

L84_2017 %>% 
  select(`Self.Reported.Gross.Floor.Area..ft².`, Number.of.Buildings, District.Steam.Use..kBtu.) %>%
  na.omit() 
#  summarise(Gross.SF = sum(Self.Reported.Gross.Floor.Area..ft².), Buildings = 
# sum(Number.of.Buildings), Steam = sum(District.Steam.Use..kBtu.))

```

