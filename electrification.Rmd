---
title: "Commercial Building Electrification at Scale"
output: 
  html_document: default 

---

```{r, echo = FALSE, message = FALSE, warning = FALSE}

##########
##########  Set up environment                                
##########

my_packages <- c("tidyverse", "vroom" , "janitor" , "glue" ,  "tsibble" , "tidytext","lubridate", "fable", "tsibbledata", "ggplot2", "forecast", "tseries", "rio", "zoo", "readxl", "tsibbledata", "knitr", "kableExtra", "formattable") 
invisible( lapply(my_packages, require, character.only = TRUE))

#Choose one working site:
place <- "Home"
# place <-  "work"


#Set proper working Dir 
if (place == "Home"){setwd("C:/Users/paulr/Documents/R/cbwg")} else
{setwd("C:/Users/prode/Documents/R/cbwg")}

# Check for data directory and if one is not present then make it
if (!file.exists("data")) {
  dir.create("data")}
  
# Set up the "not in" operator for later use. 
  `%!in%` <- Negate(`%in%`)

rm(place, my_packages )
  
```

The goal with this data project is to use the LL84 benchmarking to
identify the thermal potential in each of the building typologies. 1.
Identify the kBTU's of gas, oil and district steam used (thermal fuel)
in the commercial stock. 2. Allocate the thermal fuel among building
typologies. 3. Show ranking of typologies by sf and thermal fule volumn.
3. Show steam in manhattan as a breakout.

Data wranging actions taken
1. eliminated duplicates.
2. Deleted outliers using a simple strategy of deteating the top ten and bottom ten buildings by steam consumption.  See 65 Broadway for why this is necessary, the steam consumption value was orders of magnitude higher then possible. 

Note that while Local Law 84 data estist back to 2010 data fields before 2015 lack specific energy consumption and year built. 


Try finding and get rid of duplicates using this: 

used distict(var 1, .keep_all = TRUE)


```{r echo=FALSE, message=FALSE, warning=FALSE}

###
### Read in 2017 data 
###


L84_2017 <- read_excel("data/2017_nyc_benchmarking.xlsx", sheet = "Information and Metrics", col_names = TRUE, na = "NA" )%>% mutate(Sheet = "Information and Metrics") %>%   
  mutate(Data = "2017") %>%
  select(`Property Id`, `Property Name`, `BBL - 10 digits`, `Address 1 (self-reported)`, `Postal Code`, Borough, `Self-Reported Gross Floor Area (ft²)`, `Primary Property Type - Self Selected`, `Year Built`, `Number of Buildings`,`Fuel Oil #1 Use (kBtu)`, `Fuel Oil #2 Use (kBtu)`, `Fuel Oil #4 Use (kBtu)`, `Fuel Oil #5 & 6 Use (kBtu)`, `Diesel #2 Use (kBtu)`, `District Steam Use (kBtu)`, `Natural Gas Use (kBtu)`, `Electricity Use - Grid Purchase (kBtu)`, `Water Use (All Water Sources) (kgal)`, Sheet, Data ) %>%
  data.frame() -> L84_2017

colnames(L84_2017) <- c("Id", "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "Sheet", "Data")

L84_2017[is.na(L84_2017)] <-0

L84_2017 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect + Water)) %>%
  relocate(T.Energy, .after = Address) %>%
  arrange(BBL, T.Energy) -> L84_2017

# Remove duplicates 
L84_2017 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2017

############
############


L84_2017 %>%
  mutate(Type = fct_lump(Type, n=5, w = GSF)) %>%
  count(Type) %>%
  mutate(Type = fct_reorder(Type, n)) %>%
  ggplot(aes(Type, n)) +
  geom_col() +
  coord_flip()

L84_2017 %>%
  group_by(Type) %>%
  summarise(T.GSF = sum(GSF), T.Count = sum(No.Buildings), Weight = T.Count * T.GSF)  %>%
  arrange(desc(Weight)) %>%
  head(n=15) -> SumTable


  ggplot(data = SumTable, aes(fct_reorder(Type, Weight), Weight)) +
  geom_col() +
  coord_flip() -> plot1
  

#############
#############
```




```{r echo=FALSE, message=FALSE, warning=FALSE}
###
### Read in 2016 data 
###

L84_2016 <- read_excel("data/2016_nyc_benchmarking.xlsx", sheet = "Information and Metrics", 
            col_names = TRUE, na = "NA", col_types = NULL)%>% 
  mutate(Sheet = "Information and Metrics") %>%
            mutate(Data = "2016") %>%
  select(`Property Id`, `Property Name`, `BBL - 10 digits`, `Address 1 (self-reported)`, `Postal Code`, Borough, `DOF Gross Floor Area`, `Primary Property Type - Self Selected`, `Year Built`, `Number of Buildings - Self-reported`,`Fuel Oil #1 Use (kBtu)`, `Fuel Oil #2 Use (kBtu)`, `Fuel Oil #4 Use (kBtu)`, `Fuel Oil #5 & 6 Use (kBtu)`, `Diesel #2 Use (kBtu)`, `District Steam Use (kBtu)`, `Natural Gas Use (kBtu)`, `Electricity Use - Grid Purchase (kBtu)`, `Water Use (All Water Sources) (kgal)`, Sheet, Data ) %>%
  data.frame() -> L84_2016


colnames(L84_2016) <- c("Id", "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "Sheet", "Data") 

L84_2016$BBL <- as.numeric(L84_2016$BBL)
L84_2016$Oil2 <- as.numeric(L84_2016$Oil2)
L84_2016$Oil4 <- as.numeric(L84_2016$Oil4)
L84_2016$Oil56 <- as.numeric(L84_2016$Oil56)
L84_2016$Steam <- as.numeric(L84_2016$Steam)
L84_2016$N.Gas <- as.numeric(L84_2016$N.Gas)
L84_2016$Elect <- as.numeric(L84_2016$Elect)
L84_2016$GSF <- as.numeric(L84_2016$GSF)
L84_2016$Water <- as.numeric(L84_2016$Water)

L84_2016[is.na(L84_2016)] <-0

L84_2016 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect + Water)) %>%
  relocate(T.Energy, .after = Address) %>%
  arrange(BBL, T.Energy) -> L84_2016

L84_2016 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2016

################
################


L84_2016 %>%
  mutate(Type = fct_lump(Type, n=6, w = GSF)) %>%
  count(Type) %>%
  mutate(Type = fct_reorder(Type, n)) %>%
  ggplot(aes(Type, n)) +
  geom_col() +
  coord_flip()  -> plot2

```


```{r echo=FALSE, message=FALSE, warning=FALSE}

###
### Read in 2015 Data 
###

L84_2015 <- read_excel("data/2015_nyc_benchmarking.xlsx", sheet = "2015 Data Reported in 2016", col_names = TRUE, na = "NA", col_types = NULL )%>% mutate(Sheet = "Information and Metrics") %>%    mutate(Data = "2015") %>%
  select("Parent Property Id", "Property Name", "NYC Borough, Block and Lot (BBL)", "Street Number","Street Name" , "Zip Code", "Borough", "Property GFA - Self-reported (ft²)", "Primary Property Type - Self Selected", "Year Built", "Number of Buildings - Self-reported", "Fuel Oil #1 Use (kBtu)", "Fuel Oil #2 Use (kBtu)", "Fuel Oil #4 Use (kBtu)", "Fuel Oil #5 & 6 Use (kBtu)", "Diesel #2 Use (kBtu)", "District Steam Use (kBtu)", "Natural Gas Use (kBtu)", "Electricity Use - Grid Purchase (kBtu)", "Water Use (All Water Sources) (kgal)", Sheet, Data ) %>%
  data.frame() -> L84_2015

# Feature engineering to make consistent with base data frame. 
  L84_2015$Address <- paste(L84_2015$Street.Number, L84_2015$Street.Name, sep = ' ')
  L84_2015[-(4:5) ] -> L84_2015

  colnames(L84_2015) <- c("Id", "Name", "BBL", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "Sheet", "Data" , "Address")
  

  L84_2015 %>% select(c("Id", "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "Sheet", "Data" )) -> L84_2015
  
  L84_2015$Oil2 <- as.numeric(L84_2015$Oil2)
  L84_2015$Oil4 <- as.numeric(L84_2015$Oil4)
  L84_2015$Oil56 <- as.numeric(L84_2015$Oil56)
  L84_2015$Steam <- as.numeric(L84_2015$Steam)
  
    L84_2015[is.na(L84_2015)] <-0
  
L84_2015 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect + Water)) %>%
  relocate(T.Energy, .after = Address) %>%
  arrange(BBL, T.Energy) -> L84_2015

L84_2015 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2015

L84_2015 %>%
  mutate(Type = fct_lump(Type, n=6, w = GSF)) %>%
  count(Type) %>%
  mutate(Type = fct_reorder(Type, n)) %>%
  ggplot(aes(Type, n)) +
  geom_col() +
  coord_flip() -> plot3

```



```{r echo=FALSE, message=FALSE, warning=FALSE}

par(mfrow = c(3,1))
plot1
plot2
plot3



```



```{r echo=FALSE, message=FALSE, warning=FALSE}
###
### Join together the three years to get buildings that are in all years. 
###

inner_join(L84_2017, L84_2016, by = "BBL") -> L84_1617
inner_join(L84_1617, L84_2015, by = "BBL") -> L84_Total

bind_rows(L84_2016, L84_2015)
rlang::last_error()


```
There is a large increase in the data, filtering just on Type being office yealds. 

```{r, echo = FALSE, message = FALSE, warning = FALSE}
L84 %>%
  filter( Type == "Office") %>% 
  group_by(Data) %>%
  summarise( GSF = sum(GSF), Buildings = sum(No.Buildings)) -> Type_tables
 Type_tables %>% group_by(Data) %>% summarise("Number of Buildings" = sum(Buildings), "Footage" = sum(GSF)) -> Table2

kable(Table2, col.names = c("Year", "No.", "SqFt"), align = "cccc", caption = "Table 2 - Office  quantities and areas", format.args = list(big.mark = ',')) %>%
 kable_styling() -> Table2

Table2

```

From the pathways report categories:
1-4 Family, Multifamily, Commercial, Institutional (General, Hospitals, K-12, Religious, Universities). First I will focus on just those sites that are loabled office and exists in all years for whcih I have data. 
  Need to filter our duplicates and 0 bbl's take out the 0 bbl's first. 


```{r, echo = FALSE, message = FALSE, warning = FALSE}

#Steam QUantity Check

L84_2017 %>%
  select(Name, Address, Steam) %>%
  filter(Steam > 0) -> SteamCustomers17
sum(SteamCustomers17$Steam)/1000000

L84_2016 %>%
  select(Name, Address, Steam) %>%
  filter(Steam > 0) -> SteamCustomers16
sum(SteamCustomers16$Steam)/1000000


L84_2015 %>%
  select(Name, Address, Steam) %>%
  filter(Steam > 0) -> SteamCustomers15
sum(SteamCustomers15$Steam)/1000000


#1 LBm of steam = 1000 BTU
#1 MLBm of steam = 1000000 BTU



```

