---
title: "Commercial Building Electrification at Scale"
output: 
  html_document: default 

---

```{r, echo = FALSE, message = FALSE, warning = FALSE}

##########
##########  Set up environment                                
##########

my_packages <- c("tidyverse", "vroom" , "janitor" , "glue" ,  "tsibble" , "tidytext","lubridate", "fable", "tsibbledata", "ggplot2", "forecast", "tseries", "rio", "zoo", "readxl", "tsibbledata", "knitr", "kableExtra", "formattable") 
invisible( lapply(my_packages, require, character.only = TRUE))

#Choose one working site:
place <- "Home"
# place <-  "work"


#Set proper working Dir 
if (place == "Home"){setwd("C:/Users/paulr/Documents/R/cbwg")} else
{setwd("C:/Users/prode/Documents/R/cbwg")}

# Check for data directory and if one is not present then make it
if (!file.exists("data")) {
  dir.create("data")}
  
# Set up the "not in" operator for later use. 
  `%!in%` <- Negate(`%in%`)

rm(place, my_packages )
  
```

The goal with this data project is to use the LL84 benchmarking to
identify the thermal potential in each of the building typologies. 1.
Identify the kBTU's of gas, oil and district steam used (thermal fuel)
in the commercial stock. 2. Allocate the thermal fuel among building
typologies. 3. Show ranking of typologies by sf and thermal fule volumn.
3. Show steam in manhattan as a breakout.

Data wranging actions taken
1. eliminated duplicates.
2. Deleted outliers using a simple strategy of deteating the top ten and bottom ten buildings by steam consumption.  See 65 Broadway for why this is necessary, the steam consumption value was orders of magnitude higher then possible. 

Note that while Local Law 84 data estist back to 2010 data fields before 2015 lack specific energy consumption and year built. 


Try finding and get rid of duplicates using this: 

used distict(var 1, .keep_all = TRUE)


```{r echo=FALSE, message=FALSE, warning=FALSE}

################
# Read in data #
################


L84_2015 <- read_excel("data/2015_nyc_benchmarking.xlsx", sheet = "2015 Data Reported in 2016", col_names = TRUE, na = "NA", col_types = NULL )%>% mutate(Sheet = "Information and Metrics") %>%    mutate(Data = "2015") 

L84_2015 %>%
  select( "Record Number", "Property Name", "NYC Borough, Block and Lot (BBL)", "Street Number","Street Name" , "Zip Code", "Borough", "Property GFA - Self-reported (ft²)", "Primary Property Type - Self Selected", "Year Built", "Number of Buildings - Self-reported", "Fuel Oil #1 Use (kBtu)", "Fuel Oil #2 Use (kBtu)", "Fuel Oil #4 Use (kBtu)", "Fuel Oil #5 & 6 Use (kBtu)", "Diesel #2 Use (kBtu)", "District Steam Use (kBtu)", "Natural Gas Use (kBtu)", "Electricity Use - Grid Purchase (kBtu)", "Water Use (All Water Sources) (kgal)", Data ) %>%
  data.frame() -> L84_2015

# Feature engineering to make consistent with base data frame. 
  L84_2015$Address <- paste(L84_2015$Street.Number, L84_2015$Street.Name, sep = ' ')
  L84_2015[-(4:5) ] -> L84_2015

  colnames(L84_2015) <- c( "id", "Name", "BBL", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "Data" , "Address")
  
L84_2015[c(8:18)] <- apply(L84_2015[c(8:18)], 2, as.numeric )
L84_2015$Type <- as.factor(L84_2015$Type)
L84_2015$BBL <- as.character(L84_2015$BBL)

L84_2015[is.na(L84_2015)] <-0
  
L84_2015 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect + Water)) %>%
  relocate(Address, .after = BBL) %>% 
  relocate(T.Energy, .after = Address) %>%
  arrange(id, T.Energy) -> L84_2015

L84_2015 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0 | GSF > 25000 ) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2015



L84_2016 <- read_excel("data/2016_nyc_benchmarking.xlsx", sheet = "Information and Metrics", col_names = TRUE, na = "NA", col_types = NULL) 

L84_2016 %>% 
  mutate(Data = "2016") %>%
  select(`Property Id`, `Property Name`, `BBL - 10 digits`, `Address 1 (self-reported)`, `Postal Code`, Borough, `DOF Gross Floor Area`, `Primary Property Type - Self Selected`, `Year Built`, `Number of Buildings - Self-reported`,`Fuel Oil #1 Use (kBtu)`, `Fuel Oil #2 Use (kBtu)`, `Fuel Oil #4 Use (kBtu)`, `Fuel Oil #5 & 6 Use (kBtu)`, `Diesel #2 Use (kBtu)`, `District Steam Use (kBtu)`, `Natural Gas Use (kBtu)`, `Electricity Use - Grid Purchase (kBtu)`, `Water Use (All Water Sources) (kgal)`, Data ) %>%
  data.frame() -> L84_2016


colnames(L84_2016) <- c("id", "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "Data") 

L84_2016[c(1,5,7, 9:19)] <- apply(L84_2016[c(1,5, 7, 9:19)], 2, as.numeric )
L84_2016$Type <- as.factor(L84_2016$Type)

L84_2016[is.na(L84_2016)] <-0

L84_2016 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect + Water)) %>%
  relocate(T.Energy, .after = Address) %>%
  arrange(id, T.Energy) -> L84_2016

L84_2016 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0 | GSF > 25000) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2016


L84_2017 <- read_csv("data/Energy_and_Water_Data_Disclosure_for_Local_Law_84_2018__Data_for_Calendar_Year_2017_.csv", col_names = TRUE, na = "NA" )
L84_2017 %>% mutate(Data = "2017") %>% 
  select( `Property Id`, `Property Name`, `NYC Borough, Block and Lot (BBL)`, `Address 1`, `Postcode`, `City`, `Property GFA - Self-Reported (ft²)`, `Primary Property Type - Self Selected`, `Year Built`, `Number of Buildings`,`Fuel Oil #1 Use (kBtu)`, `Fuel Oil #2 Use (kBtu)`, `Fuel Oil #4 Use (kBtu)`, `Fuel Oil #5 & 6 Use (kBtu)`, `Diesel #2 Use (kBtu)`, `District Steam Use (kBtu)`, `Natural Gas Use (kBtu)`, `Electricity Use - Grid Purchase (kBtu)`, `Water Use (All Water Sources) (kgal)`, `Data` ) %>%
  data.frame() -> L84_2017

colnames(L84_2017) <- c("id",  "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "Data")

L84_2017[is.na(L84_2017)] <-0

L84_2017 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect + Water)) %>%
  relocate(T.Energy, .after = Address) %>%
  arrange(id, T.Energy) -> L84_2017

L84_2017[,c("Zip")] <- as.numeric(L84_2017[,c("Zip")])
L84_2017$Type <- as.factor(L84_2017$Type)

# Remove duplicates 
L84_2017 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0 | GSF > 25000 ) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2017


L84_2018 <- read_csv("data/Energy_and_Water_Data_Disclosure_for_Local_Law_84_2019__Data_for_Calendar_Year_2018_.csv", col_names = TRUE, na = "NA" )

L84_2018 %>% mutate(Data = "2018") %>% 
  select( `Property Id`, `Property Name`, `NYC Borough, Block and Lot (BBL)`, `Address 1`, `Postcode`, `City`, `Property GFA - Self-Reported (ft²)`, `Primary Property Type - Self Selected`, `Year Built`, `Number of Buildings`,`Fuel Oil #1 Use (kBtu)`, `Fuel Oil #2 Use (kBtu)`, `Fuel Oil #4 Use (kBtu)`, `Fuel Oil #5 & 6 Use (kBtu)`, `Diesel #2 Use (kBtu)`, `District Steam Use (kBtu)`, `Natural Gas Use (kBtu)`, `Electricity Use - Grid Purchase (kBtu)`, `Water Use (All Water Sources) (kgal)`, `Data` ) %>%
  data.frame() -> L84_2018

colnames(L84_2018) <- c("id", "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "Data")

L84_2018[9:19] <- apply(L84_2018[9:19] , 2, as.numeric)
L84_2018$Type <- as.factor(L84_2018$Type)

L84_2018[is.na(L84_2018)] <-0

L84_2018 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect + Water)) %>%
  relocate(T.Energy, .after = Address) %>%
  arrange(id, T.Energy) -> L84_2018

# Remove duplicates 
L84_2018 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0 | GSF > 25000 ) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2018


L84_2019 <- read_csv("data/Energy_and_Water_Data_Disclosure_for_Local_Law_84_2020__Data_for_Calendar_Year_2019_.csv", col_names = TRUE, na = "NA" )

L84_2019 %>% mutate(Data = "2019") %>% 
  select(`Property Id`, `Property Name`, `NYC Borough, Block and Lot (BBL)`, `Address 1`, `Postcode`, `City`, `Property GFA - Self-Reported (ft²)`, `Primary Property Type - Self Selected`, `Year Built`, `Number of Buildings`,`Fuel Oil #1 Use (kBtu)`, `Fuel Oil #2 Use (kBtu)`, `Fuel Oil #4 Use (kBtu)`, `Fuel Oil #5 & 6 Use (kBtu)`, `Diesel #2 Use (kBtu)`, `District Steam Use (kBtu)`, `Natural Gas Use (kBtu)`, `Electricity Use - Grid Purchase (kBtu)`, `Water Use (All Water Sources) (kgal)`, `Data` ) %>%
  data.frame() -> L84_2019

colnames(L84_2019) <- c("id", "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "Data")

L84_2019[9:19] <- apply(L84_2019[9:19], 2, as.numeric )
L84_2019$Type <- as.factor(L84_2019$Type)

L84_2019[is.na(L84_2019)] <-0

L84_2019 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect + Water)) %>%
  relocate(T.Energy, .after = Address) %>%
  arrange(id, T.Energy) -> L84_2019

# Remove duplicates 
L84_2019 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0 | GSF > 25000 ) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2019


L84_2020 <- read_csv("data/Energy_and_Water_Data_Disclosure_for_Local_Law_84_2021__Data_for_Calendar_Year_2020_.csv", col_names = TRUE, na = "NA" )

L84_2020 %>% mutate(Data = "2020") %>% 
  select(`Property Id`, `Property Name`, `NYC Borough, Block and Lot (BBL)`, `Address 1`, `Postcode`, `City`, `Property GFA - Self-Reported (ft²)`, `Primary Property Type - Self Selected`, `Year Built`, `Number of Buildings`,`Fuel Oil #1 Use (kBtu)`, `Fuel Oil #2 Use (kBtu)`, `Fuel Oil #4 Use (kBtu)`, `Fuel Oil #5 & 6 Use (kBtu)`, `Diesel #2 Use (kBtu)`, `District Steam Use (kBtu)`, `Natural Gas Use (kBtu)`, `Electricity Use - Grid Purchase (kBtu)`, `Water Use (All Water Sources) (kgal)`, `Data` ) %>%
  data.frame() -> L84_2020

colnames(L84_2020) <- c("id", "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "Data")

L84_2020[9:19] <- apply(L84_2020[9:19], 2, as.numeric )
L84_2020$Type <- as.factor(L84_2020$Type)

L84_2020[is.na(L84_2020)] <-0

L84_2020 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect + Water)) %>%
  relocate(T.Energy, .after = Address) %>%
  arrange(id, T.Energy) -> L84_2020

# Remove duplicates 
L84_2020 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0 | GSF > 25000 ) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2020



###########################
# Join data sets together #
###########################

#Create a vector containing unique same store properties by property id. 
L84_2020 %>% 
  inner_join(L84_2019, by = c("id")) %>% 
  inner_join(L84_2018, by = c("id")) %>% 
  inner_join(L84_2017, by = "id") %>% 
  inner_join(L84_2016, by = "id") %>%
  inner_join(L84_2015, by = "id") %>% 
  select(id) %>% 
  pull(id) -> AllYearsID


# create data frame of just same store properties 
L84_2015 %>% 
  filter(id %in% AllYearsID) -> temp15
L84_2016 %>% 
  filter(id %in% AllYearsID) -> temp16
L84_2017 %>% 
  filter(id %in% AllYearsID) -> temp17
L84_2018 %>% 
  filter(id %in% AllYearsID) -> temp18
L84_2019 %>% 
  filter(id %in% AllYearsID) -> temp19
L84_2020 %>% 
  filter(id %in% AllYearsID) -> temp20

bind_rows(temp15,temp16, temp17, temp18, temp19, temp20) -> SameStore

# Combine Factor Levels to align with policy and published reports
levels(SameStore$Type)<-list(
"Housing"=c("Multifamily Housing", "Senior Living Community", "Résidence pour personnes âgées", "Residence Hall/Dormitory"),

"Office"=c("Office", "Other", "Mixed Use Property", "Financial Office", "Data Center
Courthouse", "Entreposage libre-service"), 

"Hospital" =c("Senior Care Community", "Medical Office", "Hospital (General Medical & Surgical)" , "Residential Care Facility", "Urgent Care/Clinic/Other Outpatient" , "Outpatient Rehabilitation/Physical Therapy" , "Ambulatory Surgical Center" , "Other - Specialty Hospital"), 

"Retail" = c("Non-Refrigerated Warehouse", "Self-Storage Facility", "Retail Store", "Distribution Center", 
"Parking", "Refrigerated Warehouse", "Strip Mall", "Other - Entertainment/Public Assembly", "Other - Mall", "Museum", "Social/Meeting Hall", 
"Supermarket/Grocery Store", "Wholesale Club/Supercenter", "Enclosed Mall", "Fitness Center/Health Club/Gym", "Movie Theater", "Library", "Other - Services", "Performing Arts", "Automobile Dealership", "Other - Recreation", "Restaurant", "Other - Public Services", "Bowling Alley", "Personal Services (Health/Beauty, Dry Cleaning, etc.)", "Repair Services (Vehicle, Shoe, Locksmith, etc.)", "Lieu de culte", "Manufacturing/Industrial Plant", "Worship Facility",  "Social/Meeting Hall", "Courthouse", "Usine de fabrication/industrie"), 

"HigherEd" = c("Laboratory", "College/University", "Adult Education", "Vocational School"), 

"K-12" = c("K-12 School", "Other - Education", "Pre-school/Daycare"), 

"Hotel" = c("Hotel", "Other - Lodging/Residential", "Immeuble à logements multiples"), 

"Other" = c("Autre"))

SameStore %>% 
  mutate(Type_min = fct_lump(Type, n=5, w = GSF)) -> SameStore

SameStore %>% 
  group_by(Type) %>% 
  count(Type) %>% 
  arrange(desc(n)) -> SameTypes

remove(temp15, temp16, temp17, temp18, temp19, temp20)
```



```{r echo=FALSE, message=FALSE, warning=FALSE}

#Rank by number of properties
SameStore %>%
  group_by(Type_min) %>%  
  summarise("Number" = sum(No.Buildings), "GSF" = sum(GSF), "T.Energy" = sum(T.Energy)) %>% 
  arrange(desc(GSF), desc(T.Energy)) -> Types

Types %>% 
  kable(format = "html", digits = 2)

#Rank by number of properties
SameStore %>%
  count(Type_min) %>%
  mutate(Type_min = fct_reorder(Type_min, n)) %>%
  ggplot(aes(Type_min, n)) +
  geom_col() +
  labs(title = "20__") + 
  coord_flip() 


#Rank by number of properties
SameStore %>%
  filter(N.Gas != 0) %>% 
  count(Type_min) %>%
  mutate(Type_min = fct_reorder(Type_min, n)) %>%
  ggplot(aes(Type_min, n)) +
  geom_col() +
  labs(title = "20__") + 
  coord_flip() 


```


```{r echo=FALSE, message=FALSE, warning=FALSE}

L84_2015 %>%
  mutate(Type = fct_lump(Type, n=6, w = GSF)) %>%
  count(Type) %>%
  mutate(Type = fct_reorder(Type, n)) %>%
  ggplot(aes(Type, n)) +
  geom_col() +
  labs(title = "2015") + 
  coord_flip() -> plot3



par(mfrow = c(3,1))
plot1
plot2
plot3



```


```


```{r, echo = FALSE, message = FALSE, warning = FALSE}
L84 %>%
  filter( Type == "Office") %>% 
  group_by(Data) %>%
  summarise( GSF = sum(GSF), Buildings = sum(No.Buildings)) -> Type_tables
 Type_tables %>% group_by(Data) %>% summarise("Number of Buildings" = sum(Buildings), "Footage" = sum(GSF)) -> Table2

kable(Table2, col.names = c("Year", "No.", "SqFt"), align = "cccc", caption = "Table 2 - Office  quantities and areas", format.args = list(big.mark = ',')) %>%
 kable_styling() -> Table2

Table2

```

From the pathways report categories:
1-4 Family, Multifamily, Commercial, Institutional (General, Hospitals, K-12, Religious, Universities). First I will focus on just those sites that are loabled office and exists in all years for whcih I have data. 
  Need to filter our duplicates and 0 bbl's take out the 0 bbl's first. 


```{r, echo = FALSE, message = FALSE, warning = FALSE}

#Steam QUantity Check

L84_2017 %>%
  select(Name, Address, Steam) %>%
  filter(Steam > 0) -> SteamCustomers17
sum(SteamCustomers17$Steam)/1000000

L84_2016 %>%
  select(Name, Address, Steam) %>%
  filter(Steam > 0) -> SteamCustomers16
sum(SteamCustomers16$Steam)/1000000


L84_2015 %>%
  select(Name, Address, Steam) %>%
  filter(Steam > 0) -> SteamCustomers15
sum(SteamCustomers15$Steam)/1000000


#1 LBm of steam = 1000 BTU
#1 MLBm of steam = 1000000 BTU



```

