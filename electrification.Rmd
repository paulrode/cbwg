---
title: "R Notebook"
output: Comercial Building Working Group TG2 Scaling Electrificaiton  
editor_options: 
  markdown: 
    wrap: 72
---

```{r, echo="FALSE", include=FALSE, message=FALSE}

###############################################################################
#                             Set up environment                                #
###############################################################################

my_packages <- c("tidyverse", "lubridate", "fable", "tsibbledata", "ggplot2", "forecast", "tseries", "rio", "zoo", "readxl", "tsibbledata", "knitr", "kablExtra") 
lapply(my_packages, require, character.only = TRUE)

#Choose one working site:
 place <- "Home"
# place <-  "work"

#Set proper working Dir 
if (place == "Home"){setwd("C:/Users/paulr/Documents/R/cbwg")} else
{setwd("C:/Users/prode/Documents/R/cbwg")}

# Check for data directory and if one is not present then make it
if (!file.exists("data")) {
  dir.create("data")}

rm(place, my_packages )
  
```

The goal with this data project is to use the LL84 benchmarking to
identify the thermal potential in each of the building typologies. 1.
Identify the kBTU's of gas, oil and district steam used (thermal fuel)
in the commercial stock. 2. Allocate the thermal fuel among building
typologies. 3. Show ranking of typologies by sf and thermal fule volumn.
3. Show steam in manhattan as a breakout.

```{r echo="FALSE", message=FALSE, include=FALSE}

# Read in data

L84_2017 <- read_excel("data/2017_nyc_benchmarking.xlsx", sheet = "Information and Metrics", col_names = TRUE, na = "NA"  ) %>%   
  mutate(Data = "2017") %>%
  data.frame() 
L84_2016 <- read_excel("data/2016_nyc_benchmarking.xlsx", sheet = "Information and Metrics", col_names = TRUE, na = "NA"  ) %>%   
  mutate(Data = "2016")


L84_2017 %>%
  select(Property.Id, 
         NYC.Building.Identification.Number..BIN., 
         Address.1..self.reported., Borough, Property.Name, 
         `Self.Reported.Gross.Floor.Area..ft².`, 
         Primary.Property.Type...Self.Selected, 
         Year.Built, 
         Number.of.Buildings, 
         `Site.EUI..kBtu.ft².`,
         `Source.EUI..kBtu.ft².`,
         Fuel.Oil..1.Use..kBtu., 
         Fuel.Oil..2.Use..kBtu., 
         Fuel.Oil..4.Use..kBtu., 
         Fuel.Oil..5...6.Use..kBtu., 
         Diesel..2.Use..kBtu.,
         District.Steam.Use..kBtu.,
         Natural.Gas.Use..kBtu., 
         Electricity.Use...Grid.Purchase..kBtu., 
         Water.Use..All.Water.Sources...kgal., 
         Data) -> L84_a

L84_2016 %>% 
  select(`Property Id`, 
         `NYC Building Identification Number (BIN)`,
         `Address 1 (self-reported)`, Borough, `Property Name`,
         `Largest Property Use Type - Gross Floor Area (ft²)`,
         `2nd Largest Property Use - Gross Floor Area (ft²)`,
         `3rd Largest Property Use Type - Gross Floor Area (ft²)`,
         `Primary Property Type - Self Selected`,
         `Year Built`,
         `Number of Buildings - Self-reported`,
         `Site EUI (kBtu/ft²)`,
         `Source EUI (kBtu/ft²)`,
         `Fuel Oil #1 Use (kBtu)`,
         `Fuel Oil #2 Use (kBtu)`,
         `Fuel Oil #4 Use (kBtu)`,
         `Fuel Oil #5 & 6 Use (kBtu)`,
         `Diesel #2 Use (kBtu)`,
         `District Steam Use (kBtu)`,
         `Natural Gas Use (kBtu)`,
         `Electricity Use - Grid Purchase (kBtu)`,
         `Water Use (All Water Sources) (kgal)`,
         Data ) -> L84_b
L84_b$`Largest Property Use Type - Gross Floor Area (ft²)` <- as.numeric(L84_b$`Largest Property Use Type - Gross Floor Area (ft²)`)
L84_b$`2nd Largest Property Use - Gross Floor Area (ft²)` <- as.numeric(L84_b$`2nd Largest Property Use - Gross Floor Area (ft²)`)
L84_b$`3rd Largest Property Use Type - Gross Floor Area (ft²)`<-as.numeric(L84_b$`3rd Largest Property Use Type - Gross Floor Area (ft²)`)
L84_b$`Self.Reported.Gross.Floor.Area..ft².` <- L84_b$`Largest Property Use Type - Gross Floor Area (ft²)` +  L84_b$`2nd Largest Property Use - Gross Floor Area (ft²)` + L84_b$`3rd Largest Property Use Type - Gross Floor Area (ft²)`
                             



#Add GSF bins to identify where bulk of sf is by GSF ranges 50,000 up to over 500k.
c <- c("0 to 50,000", "50,000 to 100,000", "100,000 to 500,000", "500,000 to 1,000,000", "over 1,000,000")
L84_2017$bins <- cut(L84_2017$`Self.Reported.Gross.Floor.Area..ft².`, breaks = c(0,50000, 100000, 500000, 1000000, 9000000), dig.lab = 7 , ordered_result = TRUE, labels = c ) 
d <- c("pre 1942", "1942 to 1980", "1980 to 2000")
L84_2017$Year.Range <- cut(L84_2017$Year.Built, breaks = c(0, 1942, 1980, 2021),dig.lab = 4, labels = d)
remove(c,d) #clean up environment


# Add total thermal which is the sum of all thermal fuels. 

L84_2017 %>% rowwise() %>%  mutate("Total.Thermal (kBTU)" = sum(Fuel.Oil..1.Use..kBtu., Fuel.Oil..2.Use..kBtu., Fuel.Oil..4.Use..kBtu. , Fuel.Oil..5...6.Use..kBtu.,  Diesel..2.Use..kBtu. , Propane.Use..kBtu. , District.Steam.Use..kBtu. , District.Hot.Water.Use..kBtu. + District.Chilled.Water.Use..kBtu. , Natural.Gas.Use..kBtu., na.rm = TRUE) ) -> L84_2017

# Calculate Site EUI to compare to vales in the data frame
L84_2017 %>% mutate("EUI" = ifelse(is.na(Electricity.Use...Grid.Purchase..kBtu.), (`Total.Thermal (kBTU)`)/ `Self.Reported.Gross.Floor.Area..ft².`, (Electricity.Use...Grid.Purchase..kBtu. + `Total.Thermal (kBTU)`)/ `Self.Reported.Gross.Floor.Area..ft².`)) %>%
  mutate("Electric EUI" = ifelse(is.na(Electricity.Use...Grid.Purchase..kBtu.), 0, Electricity.Use...Grid.Purchase..kBtu./`Self.Reported.Gross.Floor.Area..ft².`), "Thermal EUI" = `Total.Thermal (kBTU)`/`Self.Reported.Gross.Floor.Area..ft².`, "EUI (Thermal/Total)" = `Thermal EUI`/EUI, "Site/Source EUI" = `Site.EUI..kBtu.ft².` / `Source.EUI..kBtu.ft².`) -> L84_2017

# Remove bad data using following rules: 
  #(1) Rows with 0 buildings. 
  #(2) remove rows with EUI = 0 
  #(3) remove bad 65 Broadway Manhattan and 290 Wallabout Street Brooklyn - bad data 
  #(4) remove buildings with year built < 1800
  
L84_2017 %>% filter(`Self.Reported.Gross.Floor.Area..ft².` >= 25000) %>%
  drop_na(`Site.EUI..kBtu.ft².`) %>%
  filter(Property.Name != "65 broadway llc") %>%
  filter(Property.Name != "North Shore Towers") %>%
  filter(Property.Name != "Museum of Modern Art") %>%
  filter(Property.Name != "290 Wallabout St") %>%
  filter(Year.Built > 1800) -> L84_2017

load( "./data/typetable.RData")
colnames(type.table) <- c("Primary.Property.Type...Self.Selected", "Property.Type")
L84_2017 <- left_join(L84_2017, type.table, by = "Primary.Property.Type...Self.Selected")
L84_2017$Property.Type <- as.factor(L84_2017$Property.Type)

L84_2017 %>%
  filter(Data != "Multi-BBL") %>%
  summarise("NGas.(kBtu)" = sum(Natural.Gas.Use..kBtu. , na.rm = TRUE ), "Oil.No1" = sum(Fuel.Oil..1.Use..kBtu., na.rm = TRUE), "Oil.No2" = sum(Fuel.Oil..2.Use..kBtu., na.rm = TRUE), "Oil,No4" = sum(Fuel.Oil..4.Use..kBtu., na.rm = TRUE), "Oil.No5&6" = sum(Fuel.Oil..5...6.Use..kBtu., na.rm = TRUE), "Diesel.(kBtu)" = sum(Diesel..2.Use..kBtu., na.rm = TRUE), "Propane.(kBtu)" = sum(Propane.Use..kBtu., na.rm = TRUE), "Steam.(kBtu)" = sum(District.Steam.Use..kBtu., na.rm = TRUE), "Elect.(kBtu)" = sum(Electricity.Use...Grid.Purchase..kBtu., na.rm = TRUE)) -> Total.Energy
```

What is the total thermal energy as reported through the Benchamrking
Law, and how does that compair to Electrical energy used in the same
buildings.

Use the information file.

```{r, echo="FALSE", include=FALSE, message=FALSE}

# Total Energy by Fuel Type
Total.Energy %>%
  gather(key = "Fuel.Source", value = "kBtu" ) %>%
  arrange(desc(kBtu))%>%
  mutate(Fuel.Source = factor(Fuel.Source, levels = unique(Fuel.Source))) %>% 
  ggplot(aes(x = Fuel.Source, y=kBtu, fill = Fuel.Source)) +
  geom_col() + theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  ggtitle("Total Energy by Fuel Type")
  ggsave(filename =  "Energy_by_Type.jpeg", device = "jpeg", scale = 1, width = 6, height = 4, bg = "grey")
  
# Make a box plot showing fule type statics in a box plot
L84_2017 %>%
  select(Fuel.Oil..1.Use..kBtu., Fuel.Oil..2.Use..kBtu., Fuel.Oil..4.Use..kBtu., Fuel.Oil..5...6.Use..kBtu., Diesel..2.Use..kBtu., Propane.Use..kBtu., District.Steam.Use..kBtu., Natural.Gas.Use..kBtu., Electricity.Use...Grid.Purchase..kBtu.) %>%
  gather(key = "Fuel.Source", value = "kBtu") %>%
  filter(Fuel.Source == "District.Steam.Use..kBtu.") %>%
  mutate(Fuel.Source = factor(Fuel.Source, levels = unique(Fuel.Source))) %>% 
  ggplot(aes(x = Fuel.Source, y=kBtu, fill = Fuel.Source) ) +
  geom_boxplot() + theme(axis.text.x = element_text(angle = 60, hjust = 1))
  
L84_2017 %>% select(Fuel.Oil..1.Use..kBtu., Fuel.Oil..2.Use..kBtu., Fuel.Oil..4.Use..kBtu., Fuel.Oil..5...6.Use..kBtu., Diesel..2.Use..kBtu., Propane.Use..kBtu., District.Steam.Use..kBtu., Natural.Gas.Use..kBtu., Electricity.Use...Grid.Purchase..kBtu.) %>%
  gather(key = "Fuel.Source", value = "kBtu") %>%
  filter(Fuel.Source == "District.Steam.Use..kBtu.") -> temp
summary(temp$kBtu)

  
Total.Energy%>%
  mutate("Total.Thermal.(kBtu)" = `NGas.(kBtu)`+ Oil.No1 + Oil.No2 + `Oil,No4` + `Oil.No5&6`+ `Diesel.(kBtu)`+ `Propane.(kBtu)`+ `Steam.(kBtu)`) %>%
  select(`Total.Thermal.(kBtu)`, `Elect.(kBtu)`) %>%
  gather(key = "Fuel.Source", value = "kBtu" ) %>% 
  arrange(desc(kBtu))%>%
  mutate(Fuel.Source = factor(Fuel.Source, levels = unique(Fuel.Source))) %>% 
  ggplot(aes(x = Fuel.Source, y=kBtu, fill = Fuel.Source) ) +
  geom_col() + theme(axis.text.x = element_text(angle = 60, hjust = 1))

L84_2017 %>% 
  ggplot(aes(x = `Site/Source EUI`)) +
  geom_density()

#Note how EUI ratio is lower for all electric buildings. 

L84_2017 %>%
  filter(`Total.Thermal (kBTU)`== 0) %>%
  ggplot(aes(x = `Site/Source EUI`)) +
  geom_density()

```

```{r, echo="FALSE", include=FALSE, message=FALSE}
#EUI 
L84_2017 %>% 
  filter(`Site.EUI..kBtu.ft².` < 500) %>%
  ggplot(aes( x = Property.Type, y = EUI, color = Property.Type)) +
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))

L84_2017 %>% 
  ggplot(aes(x = `EUI (Thermal/Total)`)) + 
  geom_density() +
  geom_vline(xintercept=mean(L84_2017$`EUI (Thermal/Total)` , na.rm = TRUE) ,color="blue", linetype="dashed", size=1)

#EUI by type and range
L84_2017 %>% filter(`Site.EUI..kBtu.ft².` < 500) %>%
  filter(Property.Type == "Office" | Property.Type == "Multifamily" ) %>%
  ggplot(aes( x = Year.Range, y = EUI, color = Property.Type, fill=Property.Type)) +
  geom_boxplot()

L84_2017 %>% 
  select(`Self.Reported.Gross.Floor.Area..ft².`, Number.of.Buildings, District.Steam.Use..kBtu.) %>%
  filter()

```

```{r, echo="FALSE", include=FALSE, message=FALSE}

# Read in LL84 data for 2016, change feature names, and zero out NA's

L84_2016a <- read_excel("data/2016_nyc_benchmarking.xlsx", sheet = "Information and Metrics", col_names = TRUE, na = "NA"  ) %>%   
  mutate(Data = "Information and Metrics") %>% 
  data.frame() %>% 
  select("Property.Id", "Property.Name", "BBL...10.digits", "NYC.Building.Identification.Number..BIN.", "Address.1..self.reported.", "Postal.Code", "Borough", ""Self.Reported.Gross.Floor.Area..ft²."", "Source.EUI..kBtu.ft².", "Primary.Property.Type...Self.Selected", "Year.Built", "Number.of.Buildings", "Site.EUI..kBtu.ft².","Fuel.Oil..1.Use..kBtu.", "Fuel.Oil..2.Use..kBtu.",       "Fuel.Oil..4.Use..kBtu.", "Fuel.Oil..5...6.Use..kBtu.", "Diesel..2.Use..kBtu.",        "Propane.Use..kBtu.", "District.Steam.Use..kBtu.", "District.Hot.Water.Use..kBtu.",    "District.Chilled.Water.Use..kBtu.","Natural.Gas.Use..kBtu.", "Electricity.Use...Grid.Purchase..kBtu.", "Electricity.Use...Grid.Purchase..kWh.")

L84_2017b <- read_excel("data/2016_nyc_benchmarking.xlsx", sheet = "Multi-BBL", col_names = TRUE, na = "NA"  ) %>%   
  mutate(Data = "Multi-BBL") %>% 
  data.frame() %>% 
  select("Property.Id", "Property.Name", "BBL...10.digits", "NYC.Building.Identification.Number..BIN.", "Address.1..self.reported.", "Postal.Code", "Borough", "Self.Reported.Gross.Floor.Area..ft².", "Primary.Property.Type...Self.Selected", "Year.Built", "Number.of.Buildings", "Source.EUI..kBtu.ft².", "Site.EUI..kBtu.ft².","Fuel.Oil..1.Use..kBtu.", "Fuel.Oil..2.Use..kBtu.",       "Fuel.Oil..4.Use..kBtu.", "Fuel.Oil..5...6.Use..kBtu.", "Diesel..2.Use..kBtu.",        "Propane.Use..kBtu.", "District.Steam.Use..kBtu.", "District.Hot.Water.Use..kBtu.",    "District.Chilled.Water.Use..kBtu.","Natural.Gas.Use..kBtu.", "Electricity.Use...Grid.Purchase..kBtu.", "Electricity.Use...Grid.Purchase..kWh.")
L84_2017a$BBL...10.digits <- as.character(L84_2017a$BBL...10.digits)

#combine datasets deleting duplicates and remove import files
union(L84_2017a, L84_2017b) -> L84_2017
remove("L84_2017a", "L84_2017b")
L84_2017Primary.Property.Type...Self.Selected <- as.factor(L84_2017$Primary.Property.Type...Self.Selected)


#Add GSF bins to identify where bulk of sf is by GSF ranges 50,000 up to over 500k.
c <- c("0 to 50,000", "50,000 to 100,000", "100,000 to 500,000", "500,000 to 1,000,000", "over 1,000,000")
L84_2017$bins <- cut(L84_2017$`Self.Reported.Gross.Floor.Area..ft².`, breaks = c(0,50000, 100000, 500000, 1000000, 9000000), dig.lab = 7 , ordered_result = TRUE, labels = c ) 
d <- c("pre 1942", "1942 to 1980", "1980 to 2000")
L84_2017$Year.Range <- cut(L84_2017$Year.Built, breaks = c(0, 1942, 1980, 2021),dig.lab = 4, labels = d)
remove(c,d) #clean up environment


# Add total thermal which is the sum of all thermal fuels. 

L84_2017 %>% rowwise() %>%  mutate("Total.Thermal (kBTU)" = sum(Fuel.Oil..1.Use..kBtu., Fuel.Oil..2.Use..kBtu., Fuel.Oil..4.Use..kBtu. , Fuel.Oil..5...6.Use..kBtu.,  Diesel..2.Use..kBtu. , Propane.Use..kBtu. , District.Steam.Use..kBtu. , District.Hot.Water.Use..kBtu. + District.Chilled.Water.Use..kBtu. , Natural.Gas.Use..kBtu., na.rm = TRUE) ) -> L84_2017

# Calculate Site EUI to compare to vales in the data frame
L84_2017 %>% mutate("EUI" = ifelse(is.na(Electricity.Use...Grid.Purchase..kBtu.), (`Total.Thermal (kBTU)`)/ `Self.Reported.Gross.Floor.Area..ft².`, (Electricity.Use...Grid.Purchase..kBtu. + `Total.Thermal (kBTU)`)/ `Self.Reported.Gross.Floor.Area..ft².`)) %>%
  mutate("Electric EUI" = ifelse(is.na(Electricity.Use...Grid.Purchase..kBtu.), 0, Electricity.Use...Grid.Purchase..kBtu./`Self.Reported.Gross.Floor.Area..ft².`), "Thermal EUI" = `Total.Thermal (kBTU)`/`Self.Reported.Gross.Floor.Area..ft².`, "EUI (Thermal/Total)" = `Thermal EUI`/EUI, "Site/Source EUI" = `Site.EUI..kBtu.ft².` / `Source.EUI..kBtu.ft².`) -> L84_2017

# Remove bad data using following rules: 
  #(1) Rows with 0 buildings. 
  #(2) remove rows with EUI = 0 
  #(3) remove bad 65 Broadway Manhattan and 290 Wallabout Street Brooklyn - bad data 
  #(4) remove buildings with year built < 1800
  
L84_2017 %>% filter(`Self.Reported.Gross.Floor.Area..ft².` >= 25000) %>%
  drop_na(`Site.EUI..kBtu.ft².`) %>%
  filter(Property.Name != "65 broadway llc") %>%
  filter(Property.Name != "North Shore Towers") %>%
  filter(Property.Name != "Museum of Modern Art") %>%
  filter(Property.Name != "290 Wallabout St") %>%
  filter(Year.Built > 1800) -> L84_2017

load( "./data/typetable.RData")
colnames(type.table) <- c("Primary.Property.Type...Self.Selected", "Property.Type")
L84_2017 <- left_join(L84_2017, type.table, by = "Primary.Property.Type...Self.Selected")
L84_2017$Property.Type <- as.factor(L84_2017$Property.Type)

L84_2017 %>% filter(`Site.EUI..kBtu.ft².`< 500) %>%
filter(Natural.Gas.Use..kBtu. < 10000000) %>% filter(Property.Type ==
"Office"| Property.Type == "Multifamily" ) %>% ggplot(aes( x =
Year.Range, y = Natural.Gas.Use..kBtu., color = Property.Type,
fill=Property.Type)) + geom_boxplot()
```

\#Box of gas vol 
L84_2017 %\>% filter(`Site.EUI..kBtu.ft².`< 500) %>%
filter(Natural.Gas.Use..kBtu. \< 10000000) %>% filter(Property.Type ==
"Office"| Property.Type == "Multifamily" ) %>% ggplot(aes( x =
Year.Range, y = Natural.Gas.Use..kBtu., color = Property.Type,
fill=Property.Type)) + geom_boxplot()

\#Box of gas vol L84_2017 %\>% filter(`Site.EUI..kBtu.ft².` \< 500) %\>%
filter(Property.Type == "Office" \| Property.Type == "Multifamily" )
%\>% ggplot(aes( x = Year.Range, y = `Electric EUI`,)) + geom_col(color
= "Red", position = "dodge") + geom_col(aes(x = Year.Range, y =
`Thermal EUI`), color = "Blue", position = "dodge")

L84_2017 %\>% group_by(Primary.Property.Type...Self.Selected) %\>%
summarise(GSF = sum(`Self.Reported.Gross.Floor.Area..ft².`)) %\>%
arrange(desc(GSF), by_group = TRUE) %\>% mutate("%" = 100\*GSF/sum(GSF))
-\> GSF_Table GSF_Table$GSF <- as.numeric(GSF_Table$GSF)
GSF_Table$`%` <- as.numeric(GSF_Table$`%`) GSF_Table[] \<-
lapply(GSF_Table, format, decimal.mark = ",", digits = 0, scientific =
FALSE, trim = TRUE)

L84_2017 %\>% group_by(Primary.Property.Type...Self.Selected) %\>%
summarise(TThermal.MMBtu = sum(`Total.Thermal (kBTU)`)/1000) %\>%
arrange(desc(TThermal.MMBtu, by_group = TRUE)) %\>% mutate("%" =
100\*TThermal.MMBtu/sum(TThermal.MMBtu)) -\> TThermal_Table
TThermal_Table$TThermal.MMBtu <- as.numeric(TThermal_Table$TThermal.MMBtu)
TThermal_Table$`%` <- as.numeric(TThermal_Table$`%`) TThermal_Table[]
\<- lapply(TThermal_Table, format, decimal.mark = ",", digits = 0,
scientific = FALSE, trim = TRUE)

    L84_2017 %>% filter(`Site.EUI..kBtu.ft².` < 500) %>%
      ggplot(aes( `Site.EUI..kBtu.ft².`)) +
      geom_histogram()






    GSF_bins <- L84_2017 %>%
      group_by(Catagory, bins) %>%
      summarise(GSF = sum(GSF), Num.Buildings = n(), 'Thermal (MMBtu)' = sum(total.thermal)/1000, `Electric (MMBtu)` = sum(`Electric (kBtu)`)/1000) %>% mutate(`Thermal (kBTU/GSF)` = `Thermal (MMBtu)`/GSF)
    GSF_bins$`Thermal (MMBtu)` <- format(GSF_bins$`Thermal (MMBtu)`, big.mark = ",", digits = 0, scientific = FALSE)
    GSF_bins$`Electric (MMBtu)` <- format(GSF_bins$`Electric (MMBtu)`, big.mark = ",", digits = 0, scientific = FALSE)
    GSF_bins$`Thermal kBTU/GSF` <- format(GSF_bins$`Thermal MMBTU/GSF`, big.mark = ",", digits = 2, scientific = FALSE)

    GSF_bins_dates <- L84_2017 %>%
      group_by(Catagory, bins, Dates) %>%
      summarise(GSF = sum(GSF), Num.Buildings = n(), 'Thermal (kBtu)' = sum(total.thermal), `Electric (kBtu)` = sum(`Electric (kBtu)`)) 

    L84_2017 %>% filter(Catagory != "Multifamily Housing") -> trial1
      summary()


    # Remove outliers for gsf NGas and Electric Usage
    take.out <- 10
    L84_2017 %>% arrange(GSF) -> L84_2017
    L84_2017[take.out:(nrow(L84_2017)-take.out),] -> L84_2017
    L84_2017 %>% arrange(`NGas (kBtu)`) -> L84_2017
    remove(take.out)


    GSF_bins_dates %>% filter(Catagory == "Office")

Ge these plots in the report 8/20/2021 CBWG TG7-2 Plot the following
mmbtu v gsf - points color on fuel type.\
mmbtu/gsf v year bin - points + color on category. mmbtu/gsf v decade -
points + color on category. mmbtu/gsf v gsf - points mmbtu/gsf v
cartagory - points

mmbtu/gsf v fuel type.

```{r, echo="FALSE", include=FALSE, message=FALSE}

ggplot(L84_2017, aes(Catagory)) +
  geom_bar() +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


```

```{r, echo=FALSE}
#Before making time series be sure the order is right and make a clean count feature. 
E <- E[order(E[,"Date"]),]
E_ts = ts(E[, c("kWh")])
E$clean_count = tsclean(E$'kWh')
plot(E_ts)


#Running the decompose function with both additive and Multiplicative. With additive being Ts = Seasonal + Trend + Random, and multiplicative being Ts = Seasonal x trend x random. 



#Read in the steam data. 
S <- read_csv("C:/Users/paulr/Documents/R/EnergyForecasting/data/MACH Energy - Data (S).csv", skip = 0, na = "Not Available") 

#Before making time series be sure the order is right and make a clean count feature. 
S <- S[order(E[,"Date"]),]
S_ts = ts(S[, c("Value")])
S$clean_count = tsclean(S$'kWh')
plot(S_ts)


```

```{r}
tsbl_elec <- tsibbledata::vic_elec %>% filter(Date < ymd("2014-03-01")) %>% mutate("WorkDay" = wday(Date) )


fbl_elec_fit <- tsbl_elec %>%
  model(arima = ARIMA(Demand ~ WorkDay + Temperature + I(Temperature^2)))
        #, pdq(1,0,1) + PDQ(1,1,1, period = "day"))



tsbl_elec_new <- tsibbledata::vic_elec %>% 
  filter(Date >= ymd("2014-03-01"), Date < ymd("2014-03-14"))


fbl_elec_fc <- fbl_elec_fit %>%
  forecast(tsbl_elec_new)

view(vic_elec)
view(tsbl_elec_new)
```

Accurach evaluation to compare models accuracy(mable, measures, ...)
accuracy(fable, new_data, measures, ...)

fbl_cafe_fit %\>% accuracy()

Or

fbl_elec_fc %\>% accuracy(tsbl_elec_new)

This makes 152 models. fbl_cafe_fit retail_ets \<-
tsibbledata::ausretail %\> ETS(Turnover)

Now use

Extract(broom::augment) augment(retail_ets)

Extract(broom::tidy) tidy(retail_ets)

Extract(broom::glance) glance(retail_ets)

Extract(fable::components) components(retail_ets)

Example: components(retail_ets) %\>% filter(Industry == "Cafes,
restaurants and takeaway food services") %\>% ggplot(aes(x = Month, y =
level, color = State)) + geom_line()

Forecast retail_fc \<- retail_ets %\>% forecast(h=24)

Evaluate retail_ets %\>% accuracy() measures? to check difference in
accuracy maybe?

```{r}

```

Forecasting with Fasster showing electric

fasster_fit \<- tsbl_elec %\>% fasster(log(Demand) \~ WorkDay %S%
(trig(48,16) + poly(1)) + Temperture + I(Temperture\^2))

using exoginest regressors for workday and temperture.

fasster_fc \<- fasster_fit %\>% forecast(tsbl_elec_new)

fasster_fc %\>% autoplot(tsbl_elec)

```{r}


```

Coming Simulate() future paths

set.seed(20181108) vic_cafe_sim \<- fbl_cafe_fit %\>% simulate( h = 24,
times = 5)

vic_cafe %\>% filter(year(Month) \>= 2021) %\>% autoplot(Turnover) +
geom_line(aes(y = .sim, group = .rep), alpha = 0.3, data = vic_cafe_sim)

Feture: interpolate() missing values

tsibbledata::olympic_running

fit a model then interpolate.

olympic_complete \<- olympic_running %\>% TSLM(Time \~ trend()) %\>%
interpolate(olympic_running)

refit() allows a model to be applied to a new dataset stream() allows a
model to be extended using new data

stream is good when you have a model and get additional time series data
you just add it and the modeling is redone.

fasster_stream \<- fasster_fit %\>% stream(tsbl_elec_new)

Decomposition forecasting library(tsibblestats) cafe_dcmp \<- vic_cafe
%\>% STL(log(Turnover))

Interval and distribution accuracy fbl_elec_fc %\>% accuracy( new_data =
tsbl_elec_new, measures = list(winkler = winkler_score, percentile =
perentiale_score)

)
