---
title: "Commercial Building Electrification at Scale"
output: 
  html_document: default 

---

```{r, echo = FALSE, message = FALSE, warning = FALSE}

##########################################
##########  Set up environment  ##########                              
##########################################

my_packages <- c("tidyverse", "vroom" , "janitor" , "glue" ,  "tsibble" , "tidytext","lubridate", "fable", "tsibbledata", "ggplot2", "forecast", "tseries", "rio", "zoo", "readxl", "tsibbledata", "knitr", "kableExtra", "formattable") 
invisible( lapply(my_packages, require, character.only = TRUE))

#Choose one working site:
# place <- "Home"
 place <-  "work"


#Set proper working Dir 
if (place == "Home"){setwd("C:/Users/paulr/Documents/R/cbwg")} else
{setwd("C:/Users/prode/Documents/R/cbwg")}

# Check for data directory and if one is not present then make it
if (!file.exists("data")) {
  dir.create("data")}
  
# Set up the "not in" operator for later use. 
  `%!in%` <- Negate(`%in%`)

rm(place, my_packages )
  


################
# Read in data #
################

LL97Text <- "https://www1.nyc.gov/assets/buildings/local_laws/ll97of2019.pdf"

L84_2015 <- read_excel("data/2015_nyc_benchmarking.xlsx", sheet = "2015 Data Reported in 2016", col_names = TRUE, na = "NA", col_types = NULL )%>% mutate(Sheet = "Information and Metrics") %>%    mutate(Data = "2015") 

L84_2015 %>%
  select( "Record Number", "Property Name", "NYC Borough, Block and Lot (BBL)", "Street Number","Street Name" , "Zip Code", "Borough", "Property GFA - Self-reported (ft²)", "Primary Property Type - Self Selected", "Year Built", "Number of Buildings - Self-reported", "Fuel Oil #1 Use (kBtu)", "Fuel Oil #2 Use (kBtu)", "Fuel Oil #4 Use (kBtu)", "Fuel Oil #5 & 6 Use (kBtu)", "Diesel #2 Use (kBtu)", "District Steam Use (kBtu)", "Natural Gas Use (kBtu)", "Electricity Use - Grid Purchase (kBtu)", "Water Use (All Water Sources) (kgal)", Data ) %>%
  data.frame() -> L84_2015

# Feature engineering to make consistent with base data frame. 
  L84_2015$Address <- paste(L84_2015$Street.Number, L84_2015$Street.Name, sep = ' ')
  L84_2015[-(4:5) ] -> L84_2015

  colnames(L84_2015) <- c( "id", "Name", "BBL", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "Data" , "Address")
  
L84_2015[c(8:19)] <- apply(L84_2015[c(8:19)], 2, as.numeric )
L84_2015$Type <- as.factor(L84_2015$Type)
L84_2015$BBL <- as.character(L84_2015$BBL)

L84_2015[is.na(L84_2015)] <-0
  
L84_2015 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect )) %>%
  relocate(Address, .after = BBL) %>% 
  relocate(T.Energy, .after = Address) %>%
  arrange(id, T.Energy) -> L84_2015

L84_2015 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0 | GSF > 25000 ) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2015



L84_2016 <- read_excel("data/2016_nyc_benchmarking.xlsx", sheet = "Information and Metrics", col_names = TRUE, na = "NA", col_types = NULL) 

L84_2016 %>% 
  mutate(Data = "2016") %>%
  select(`Property Id`, `Property Name`, `BBL - 10 digits`, `Address 1 (self-reported)`, `Postal Code`, Borough, `DOF Gross Floor Area`, `Primary Property Type - Self Selected`, `Year Built`, `Number of Buildings - Self-reported`,`Fuel Oil #1 Use (kBtu)`, `Fuel Oil #2 Use (kBtu)`, `Fuel Oil #4 Use (kBtu)`, `Fuel Oil #5 & 6 Use (kBtu)`, `Diesel #2 Use (kBtu)`, `District Steam Use (kBtu)`, `Natural Gas Use (kBtu)`, `Electricity Use - Grid Purchase (kBtu)`, `Water Use (All Water Sources) (kgal)`, Data ) %>%
  data.frame() -> L84_2016


colnames(L84_2016) <- c("id", "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "Data") 

L84_2016[c(1,5,7, 9:20)] <- apply(L84_2016[c(1,5, 7, 9:20)], 2, as.numeric )
L84_2016$Type <- as.factor(L84_2016$Type)

L84_2016[is.na(L84_2016)] <-0

L84_2016 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect )) %>%
  relocate(T.Energy, .after = Address) %>%
  arrange(id, T.Energy) -> L84_2016

L84_2016 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0 | GSF > 25000) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2016


L84_2017 <- read_csv("data/Energy_and_Water_Data_Disclosure_for_Local_Law_84_2018__Data_for_Calendar_Year_2017_.csv", col_names = TRUE, na = "NA" )

L84_2017 %>% mutate(Data = "2017") %>% 
  select( `Property Id`, `Property Name`, `NYC Borough, Block and Lot (BBL)`, `Address 1`, `Postcode`, `City`, `Property GFA - Self-Reported (ft²)`, `Primary Property Type - Self Selected`, `Year Built`, `Number of Buildings`,`Fuel Oil #1 Use (kBtu)`, `Fuel Oil #2 Use (kBtu)`, `Fuel Oil #4 Use (kBtu)`, `Fuel Oil #5 & 6 Use (kBtu)`, `Diesel #2 Use (kBtu)`, `District Steam Use (kBtu)`, `Natural Gas Use (kBtu)`, `Electricity Use - Grid Purchase (kBtu)`, `Water Use (All Water Sources) (kgal)`, `Data` ) %>%
  data.frame() -> L84_2017

colnames(L84_2017) <- c("id",  "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "Data")

L84_2017[is.na(L84_2017)] <-0

L84_2017 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect )) %>%
  relocate(T.Energy, .after = Address) %>%
  arrange(id, T.Energy) -> L84_2017

L84_2017[,c("Zip")] <- as.numeric(L84_2017[,c("Zip")])
L84_2017[, "Data"] <- as.numeric(L84_2017[,"Data"])
L84_2017$Type <- as.factor(L84_2017$Type)

# Remove duplicates 
L84_2017 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0 | GSF > 25000 ) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2017


L84_2018 <- read_csv("data/Energy_and_Water_Data_Disclosure_for_Local_Law_84_2019__Data_for_Calendar_Year_2018_.csv", col_names = TRUE, na = "NA" )

L84_2018 %>% mutate(Data = "2018") %>% 
  select( `Property Id`, `Property Name`, `NYC Borough, Block and Lot (BBL)`, `Address 1`, `Postcode`, `City`, `Property GFA - Self-Reported (ft²)`, `Primary Property Type - Self Selected`, `Year Built`, `Number of Buildings`,`Fuel Oil #1 Use (kBtu)`, `Fuel Oil #2 Use (kBtu)`, `Fuel Oil #4 Use (kBtu)`, `Fuel Oil #5 & 6 Use (kBtu)`, `Diesel #2 Use (kBtu)`, `District Steam Use (kBtu)`, `Natural Gas Use (kBtu)`, `Electricity Use - Grid Purchase (kBtu)`, `Water Use (All Water Sources) (kgal)`, `Data` ) %>%
  data.frame() -> L84_2018

colnames(L84_2018) <- c("id", "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "Data")

L84_2018[9:20] <- apply(L84_2018[9:20] , 2, as.numeric)
L84_2018$Type <- as.factor(L84_2018$Type)

L84_2018[is.na(L84_2018)] <-0

L84_2018 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect )) %>%
  relocate(T.Energy, .after = Address) %>%
  arrange(id, T.Energy) -> L84_2018

# Remove duplicates 
L84_2018 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0 | GSF > 25000 ) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2018


L84_2019 <- read_csv("data/Energy_and_Water_Data_Disclosure_for_Local_Law_84_2020__Data_for_Calendar_Year_2019_.csv", col_names = TRUE, na = "NA" )

L84_2019 %>% mutate(Data = "2019") %>% 
  select(`Property Id`, `Property Name`, `NYC Borough, Block and Lot (BBL)`, `Address 1`, `Postcode`, `City`, `Property GFA - Self-Reported (ft²)`, `Primary Property Type - Self Selected`, `Year Built`, `Number of Buildings`,`Fuel Oil #1 Use (kBtu)`, `Fuel Oil #2 Use (kBtu)`, `Fuel Oil #4 Use (kBtu)`, `Fuel Oil #5 & 6 Use (kBtu)`, `Diesel #2 Use (kBtu)`, `District Steam Use (kBtu)`, `Natural Gas Use (kBtu)`, `Electricity Use - Grid Purchase (kBtu)`, `Water Use (All Water Sources) (kgal)`, `Data` ) %>%
  data.frame() -> L84_2019

colnames(L84_2019) <- c("id", "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "Data")

L84_2019[9:20] <- apply(L84_2019[9:20], 2, as.numeric )
L84_2019$Type <- as.factor(L84_2019$Type)

L84_2019[is.na(L84_2019)] <-0

L84_2019 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect )) %>%
  relocate(T.Energy, .after = Address) %>%
  arrange(id, T.Energy) -> L84_2019

# Remove duplicates 
L84_2019 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0 | GSF > 25000 ) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2019


L84_2020 <- read_csv("data/Energy_and_Water_Data_Disclosure_for_Local_Law_84_2021__Data_for_Calendar_Year_2020_.csv", col_names = TRUE, na = "NA" )

L84_2020 %>% mutate(Data = "2020") %>% 
  select(`Property Id`, `Property Name`, `NYC Borough, Block and Lot (BBL)`, `Address 1`, `Postcode`, `City`, `Property GFA - Self-Reported (ft²)`, `Primary Property Type - Self Selected`, `Year Built`, `Number of Buildings`,`Fuel Oil #1 Use (kBtu)`, `Fuel Oil #2 Use (kBtu)`, `Fuel Oil #4 Use (kBtu)`, `Fuel Oil #5 & 6 Use (kBtu)`, `Diesel #2 Use (kBtu)`, `District Steam Use (kBtu)`, `Natural Gas Use (kBtu)`, `Electricity Use - Grid Purchase (kBtu)`, `Water Use (All Water Sources) (kgal)`, `Data` ) %>%
  data.frame() -> L84_2020

colnames(L84_2020) <- c("id", "Name", "BBL", "Address", "Zip", "Boruugh", "GSF", "Type", "Built", "No.Buildings", "Oil1", "Oil2", "Oil4", "Oil56", "Diesel", "Steam", "N.Gas", "Elect", "Water", "Data")

L84_2020[9:20] <- apply(L84_2020[9:20], 2, as.numeric )
L84_2020$Type <- as.factor(L84_2020$Type)

L84_2020[is.na(L84_2020)] <-0

L84_2020 %>% mutate("T.Energy" = (Oil2 + Oil4 + Oil56 + Steam + N.Gas + Elect)) %>%
  relocate(T.Energy, .after = Address) %>%
  arrange(id, T.Energy) -> L84_2020

# Remove duplicates 
L84_2020 %>% arrange(BBL, Address, T.Energy) %>%
  distinct() %>%
  filter( T.Energy != 0 | GSF > 25000 ) %>%
  distinct(BBL, .keep_all = TRUE) %>%
  filter(BBL != 0) -> L84_2020



###########################
# Join data sets together #
###########################

#Create a vector containing unique same store properties by property id. 
L84_2020 %>% 
  inner_join(L84_2019, by = "BBL") %>% 
  inner_join(L84_2018, by = "BBL") %>% 
  inner_join(L84_2017, by = "BBL") %>% 
  inner_join(L84_2016, by = "BBL") %>%
  inner_join(L84_2015, by = "BBL") %>% 
  select(BBL) %>% 
  pull(BBL) -> AllYearsID


# create data frame of just same store properties 
L84_2015 %>% 
  filter(BBL %in% AllYearsID) -> temp15
L84_2016 %>% 
  filter(BBL %in% AllYearsID) -> temp16
L84_2017 %>% 
  filter(BBL %in% AllYearsID) -> temp17
L84_2018 %>% 
  filter(BBL %in% AllYearsID) -> temp18
L84_2019 %>% 
  filter(BBL %in% AllYearsID) -> temp19
L84_2020 %>% 
  filter(BBL %in% AllYearsID) -> temp20

bind_rows(temp15,temp16, temp17, temp18, temp19, temp20) -> SameStore

remove(temp15, temp16, temp17, temp18, temp19, temp20)



####################################################################
# Combine Factor Levels to align with policy and published reports #
####################################################################

levels(SameStore$Type) <-list(
"Housing"=c("Multifamily Housing", "Senior Living Community", "Résidence pour personnes âgées", "Autre"),


"Office" =c("Office", "Other", "Mixed Use Property", "Financial Office", "Data Center", 
"Courthouse", "Entreposage libre-service"), 


"Hospital" =c("Senior Care Community", "Medical Office", "Hospital (General Medical & Surgical)" , "Residential Care Facility", "Urgent Care/Clinic/Other Outpatient" , "Outpatient Rehabilitation/Physical Therapy" , "Ambulatory Surgical Center" , "Other - Specialty Hospital"), 


"Retail" = c("Non-Refrigerated Warehouse", "Self-Storage Facility", "Retail Store", "Distribution Center", 
"Parking", "Refrigerated Warehouse", "Strip Mall", "Other - Entertainment/Public Assembly", "Other - Mall", "Museum", "Social/Meeting Hall", 
"Supermarket/Grocery Store", "Wholesale Club/Supercenter", "Enclosed Mall", "Fitness Center/Health Club/Gym", "Movie Theater", "Library", "Other - Services", "Performing Arts", "Automobile Dealership", "Other - Recreation", "Restaurant", "Other - Public Services", "Bowling Alley", "Personal Services (Health/Beauty, Dry Cleaning, etc.)", "Repair Services (Vehicle, Shoe, Locksmith, etc.)", "Lieu de culte", "Manufacturing/Industrial Plant", "Worship Facility",  "Social/Meeting Hall", "Courthouse", "Usine de fabrication/industrie"), 


"HigherEd" = c("Laboratory", "College/University", "Adult Education", "Vocational School"), 


"K-12" = c("K-12 School", "Other - Education", "Pre-school/Daycare"), 


"Hotel" = c("Hotel", "Other - Lodging/Residential", "Immeuble à logements multiples", "Residence Hall/Dormitory"))


#Code piece to narrow down Tyeps. 
#SameStore %>% 
#  mutate(Type_min = fct_lump(Type, n=5, w = GSF)) -> SameStore



#########################
# Add carbon parameters # 
#########################

EmissionLimits <- read_excel("data/LL97Parameters .xlsx", sheet = "EmissionsLimits", col_names = TRUE, na = "NA",col_types = c("numeric", "text", "numeric", "text", "numeric") ) %>% drop_na()

CarbonFactors <- read_excel("data/LL97Parameters .xlsx", sheet = "CarbonFactors", col_names = TRUE, na = "NA",col_types = c("text", "numeric", "text", "numeric") ) %>% drop_na()



#################################
# Make Building Types dataframe #
#################################

#Rank by number of properties
SameStore %>%
  group_by(Type) %>%  
  summarise("Number" = sum(No.Buildings), GSF_1000xSF = sum(GSF), T.Energy_MMbtu = sum(T.Energy))  %>% 
  mutate(GSF_1000xSF  = GSF_1000xSF/1000, T.Energy_MMbtu = T.Energy_MMbtu/1000) %>% 
  arrange(desc(T.Energy_MMbtu)) -> Types



####################
# Make Types table #
####################

SameStore %>% 
  group_by(Type) %>% 
  count(Type) %>% 
  arrange(desc(n)) -> SameTypes


###########
# Add EUI #
###########


SameStore %>% 
  filter(GSF != 0) %>% 
  mutate(EUI = T.Energy/GSF) %>%
  relocate(EUI, .after = Address) -> SameStore

```



```{r echo=FALSE, message=FALSE, warning=FALSE}

#Table of buildings in dataset 
Types %>% 
    mutate(across(where(is.numeric), signif, 3)) %>%  
    kable(format = "html", digits = 6, col.names = c("Use Type", "Quantity", "GSF", "Total Energy (kBTU)" )) %>%     kable_styling(full_width = FALSE)


      
#Rank by number of properties
SameStore %>%
  count(Type) %>%
  mutate(Type = fct_reorder(Type, n)) %>%
  ggplot(aes(Type, n)) +
  geom_col() +
  labs(y = "Number of Buildings", x = "Use Types", title = "Counts of Buildings submitted for 2021 period") + 
  coord_flip() 

# Show kGSF comparision of all Types. 
Types %>% 
  mutate(across(where(is.numeric), signif, 3)) %>% 
  mutate(Type = fct_reorder(Type, GSF_1000xSF)) %>%
  ggplot(aes(Type, GSF_1000xSF)) +
  geom_col() +
  labs(y = "Number of Buildings", x = "Use Types", title = "GSF of Buildings submitted for 2021 period") + 
  coord_flip() 



```
Treatment of outliers. I sorted on EUI and chost IQR as the tool for this. Also it looks like housing and office are the most accurate. Hotels and Hospitals not so much which for hospitals is unsupprising. 

```{r echo=FALSE, message=FALSE, warning=FALSE}

############################################
#  Get rid of outliers and calculate error #
############################################

# Two approaches one using IQR other dumping "0"s Pick one or the others

# 1 find Q1, Q3, and interquartile range for values in column A 
Q1 <- quantile(SameStore$EUI, .25) 
Q3 <- quantile(SameStore$EUI, .75)
IQR <- IQR(SameStore$EUI)

#only keep rows in dataframe that have values within 1.5*IQR of Q1 and Q3
SameStore_no_outliers <- subset(SameStore, SameStore$EUI> (Q1 - 1.5*IQR) & SameStore$EUI< (Q3 + 1.5*IQR))

remove(AllYearsID, IQR, Q1, Q3)

# 2 get rid of 0's
# SameStore %>% 
#  filter(T.Energy != 0) %>% 
#  filter(GSF != 0)-> SameStore_no_outliers


SameStore_no_outliers %>%
  group_by(Type) %>%  
  summarise("Number" = sum(No.Buildings), GSF_1000xSF = sum(GSF), T.Energy_MMbtu = sum(T.Energy))  %>% 
  mutate(Number_no_out = Number, GSF_no_out  = GSF_1000xSF/1000, T.Energy_no_out = T.Energy_MMbtu/1000) %>% arrange(desc(T.Energy_no_out)) %>% 
  select(Type, Number_no_out, GSF_no_out, T.Energy_no_out) -> Types_no_outliers

inner_join(Types, Types_no_outliers, by = "Type") %>% 
  mutate(N = (Number - Number_no_out)/Number, GSF = (GSF_1000xSF- GSF_no_out)/GSF_1000xSF, T.Energy = (T.Energy_MMbtu - T.Energy_no_out)/T.Energy_MMbtu ) %>% 
  select(Type, Number, Number_no_out, N, GSF_1000xSF, GSF_no_out, GSF,T.Energy_MMbtu, T.Energy_no_out, T.Energy)  -> Outlier_error

Outlier_error[c("N", "GSF", "T.Energy")] <- round(Outlier_error[c("N", "GSF", "T.Energy")],2)



##########
# Charts #
##########


SameStore_no_outliers %>% 
  filter(Type == "Office") %>% 
  ggplot(aes(x = Built, y = EUI, color = Data)) +
  geom_point() +
  geom_smooth() +
  facet_grid(Data ~.) +
  geom_vline(aes(xintercept = 1930), color = "red") +
  labs( title = "Office EUI by build year and LL84 datasets")

SameStore_no_outliers %>% 
  filter(Type == "Office") %>% 
  group_by(Built) %>% 
  summarise("N.Build" = sum(No.Buildings), Data) %>% 
  ggplot(aes(x = Built, y = N.Build)) +
  geom_point() +
  geom_smooth() +
  geom_vline(aes(xintercept = 1942)) +
  geom_vline(aes(xintercept = 1945)) +
  geom_vline(aes(xintercept = 1930, color = "red"))
 

SameStore_no_outliers %>% 
  group_by(Data) %>% 
  summarise("No.Buildings" = sum(No.Buildings), "Mean EUI" = mean(EUI), "T.Energy" = sum(T.Energy)/1000000000) %>% 
  kable(format = "html")

SameStore_no_outliers %>% 
  group_by(Type) %>% 
  summarise("Total.Energy" = sum(T.Energy), "Elect" = sum(Elect), "NGas" = sum(N.Gas), "Steam" = sum(Steam)) %>% 
  kable(format = "html", digits = 2) 


SameStore_no_outliers %>% 
  group_by(Type) %>% 
  summarise("Elect" = (sum(Elect)/6), "NGas" = (sum(N.Gas)/6), "Steam" = (sum(Steam))/6) %>% 
  gather(key = "Energy", value = "Utilities", Elect, Steam, NGas, -Type, factor_key = TRUE) %>% 
  ggplot(aes(Type, Utilities, fill = Energy)) +
  geom_col(position = "stack") +
  labs(title = "Energy Use by Building Type"  ) %>%  
  ggsave( plot = last_plot(), device = "jpeg",
  path = "C:/Users/paulr/Documents/R/cbwg/", scale = 1 )

SameStore_no_outliers %>%
  filter(Data == 2019) %>% 
  group_by(Type) %>% 
  summarise("Elect" = sum(Elect), "NGas" = sum(N.Gas), "Steam" = sum(Steam)) %>% 
  gather(key = "Energy", value = "Utilities", Elect, Steam, NGas, -Type, factor_key = TRUE) %>% 
  ggplot(aes(Type, Utilities, fill = Energy)) +
  geom_col(position = "stack")+
  labs(title = "Energy Use by Building Type using 2019 data only") %>% 
  ggsave( plot = last_plot(), device = "jpeg",
  path = "C:/Users/paulr/Documents/R/cbwg/", scale = 1 )

SameStore_no_outliers %>%
  filter(Data == 2020) %>% 
  group_by(Type) %>% 
  summarise("Elect" = sum(Elect), "NGas" = sum(N.Gas), "Steam" = sum(Steam)) %>% 
  gather(key = "Energy", value = "Utilities", Elect, Steam, NGas, -Type, factor_key = TRUE) %>% 
  ggplot(aes(Type, Utilities, fill = Energy)) +
  geom_col(position = "stack")+
  labs(title = "Energy Use by Building Type using 2020 data only") %>% 
  ggsave( plot = last_plot(), device = "jpeg",
  path = "C:/Users/paulr/Documents/R/cbwg/", scale = 1 )



###################################################################################
# put carbon in here... using join #
###################################################################################


SameStore_no_outliers %>%
  filter(Data == 2019) %>% 
  group_by(Type) %>% 
  summarise("Elect" = sum(Elect), "NGas" = sum(N.Gas), "Steam" = sum(Steam)) %>% 
  gather(key = "Energy", value = "Utilities", Elect, Steam, NGas, -Type, factor_key = TRUE) %>% 
  left_join(CarbonFactors, by = "Energy") %>% 
  mutate_at(vars(matches("Factor")), ~ifelse(Energy == "Elect", 0.000288962/3.214, .)) %>% 
  mutate(carbon_tCO2e = Utilities * Factor)  %>% 
  ggplot(aes(Type, carbon_tCO2e, fill = Energy)) +
  geom_col(position = "stack")+
  labs(title = "Carbon by Building Type using 2019 data only") %>% 
  ggsave( plot = last_plot(), device = "jpeg",
  path = "C:/Users/paulr/Documents/R/cbwg/", scale = 1 )

#Calculate emmisions limits per year 
SameStore_no_outliers %>% 
  filter(Type == "Office") %>% 
  group_by(Data) %>% 
   summarise("Elect" = sum(Elect), "NGas" = sum(N.Gas), "Steam" = sum(Steam), GSF = sum(GSF)) %>% 
  mutate("EmmisionsLimit" = 0.00846 * GSF) -> SameStore_no_outliersSummary
OfficeEmmisions <- mean(SameStore_no_outliersSummary$EmmisionsLimit)  
remove(SameStore_no_outliersSummary)

############################################################################
############################################################################
SameStore_no_outliers %>% 
  filter(Type == "Office") %>% 
  select(Data, Elect, Steam, N.Gas, GSF) %>% 
  gather(key = "Energy", value = "Utilities", Elect, Steam, N.Gas, -Data, factor_key = TRUE) %>% 
  left_join(CarbonFactors, by = "Energy") %>% 
  mutate_at(vars(matches("Factor")), ~ifelse(Energy == "Elect", 0.000288962/3.214, .)) %>% 
  mutate(carbon_tCO2e = Utilities * Factor) %>% 
  filter(Data == 2020) %>% 
  mutate("CUI" = carbon_tCO2e / GSF) %>% 
  ggplot(aes(GSF, CUI)) +
  geom_point() +
  geom_hline(aes(yintercept = 0.00846)) +
  labs(title = "Office Carbon by year by Scope", x = "Submission Yeaer", y = "tCO2e") %>% 
  ggsave( plot = last_plot(), device = "jpeg",
  path = "C:/Users/paulr/Documents/R/cbwg/", scale = 1 )

############################################################################
############################################################################

SameStore_no_outliers %>% 
  filter(Type == "Office") %>% 
  group_by(Data) %>% 
  summarise("Elect" = sum(Elect), "NGas" = sum(N.Gas), "Steam" = sum(Steam), GSF = sum(GSF)) %>% 
  gather(key = "Energy", value = "Utilities", Elect, Steam, NGas, -Data, factor_key = TRUE) %>% 
  left_join(CarbonFactors, by = "Energy") %>% 
  mutate_at(vars(matches("Factor")), ~ifelse(Energy == "Elect", 0.000288962/3.214, .)) %>% 
  mutate(carbon_tCO2e = Utilities * Factor)   %>% 
  ggplot(aes(Data, carbon_tCO2e, fill = Energy)) +
  geom_col(position = "stack") +
  geom_hline(aes(yintercept = OfficeEmmisions)) +
  labs(title = "Office Carbon by year by Scope", x = "Submission Yeaer", y = "tCO2e") %>% 
  ggsave( plot = last_plot(), device = "jpeg",
  path = "C:/Users/paulr/Documents/R/cbwg/", scale = 1 )




SameStore_no_outliers %>% 
  filter(Type == "Housing") %>% 
  group_by(Data) %>% 
  summarise("Elect" = sum(Elect), "NGas" = sum(N.Gas), "Steam" = sum(Steam)) %>% 
  gather(key = "Energy", value = "Utilities", Elect, Steam, NGas, -Data, factor_key = TRUE) %>% 
  left_join(CarbonFactors, by = "Energy") %>% 
  mutate_at(vars(matches("Factor")), ~ifelse(Energy == "Elect", 0.000288962/3.214, .)) %>% 
  mutate(carbon_tCO2e = Utilities * Factor)  %>% 
  ggplot(aes(Data, carbon_tCO2e, fill = Energy)) +
  geom_col(position = "stack")+
  labs(title = "Multifamily Housing Carbon by year by Scope", x = "Submission Year") %>% 
  ggsave( plot = last_plot(), device = "jpeg",
  path = "C:/Users/paulr/Documents/R/cbwg/", scale = 1 )




```

