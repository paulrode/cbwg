---
title: "Commercial Building Electrification at Scale"
output: 
  html_document: default 

---

```{r, echo = FALSE, message = FALSE, warning = FALSE}

###############################################################################
#                             Set up environment                                #
###############################################################################

my_packages <- c("tidyverse", "vroom" , "janitor" , "glue" ,  "tsibble" , "tidytext","lubridate", "fable", "tsibbledata", "ggplot2", "forecast", "tseries", "rio", "zoo", "readxl", "tsibbledata", "knitr", "kablExtra", "formattable") 
invisible( lapply(my_packages, require, character.only = TRUE))

#Choose one working site:
 place <- "Home"
# place <-  "work"


#Set proper working Dir 
if (place == "Home"){setwd("C:/Users/paulr/Documents/R/cbwg")} else
{setwd("C:/Users/prode/Documents/R/cbwg")}

# Check for data directory and if one is not present then make it
if (!file.exists("data")) {
  dir.create("data")}
  
# Set up the not in operator 
  `%!in%` <- Negate(`%in%`)

rm(place, my_packages )
  
```

The goal with this data project is to use the LL84 benchmarking to
identify the thermal potential in each of the building typologies. 1.
Identify the kBTU's of gas, oil and district steam used (thermal fuel)
in the commercial stock. 2. Allocate the thermal fuel among building
typologies. 3. Show ranking of typologies by sf and thermal fule volumn.
3. Show steam in manhattan as a breakout.

Data wranging actions taken
1. eliminated duplicates.
2. Deleted outliers using a simple strategy of deteating the top ten and bottom ten buildings by steam consumption.  See 65 Broadway for why this is necessary, the steam consumption value was orders of magnitude higher then possible. 


```{r echo=FALSE, message=FALSE, warning=FALSE}

# Read in data and wrange
L84_2017 <- read_excel("data/2017_nyc_benchmarking.xlsx", sheet = "Information and Metrics", col_names = TRUE, na = "NA" )%>% mutate(Sheet = "Information and Metrics") %>%   
  mutate(Data = "2017") %>%
  select(2:3, 6,9, 14, 16:17, 25:26, 30:31, 33, 37:43, 45:46,48, 61:62 ) %>%
  select(-12,-13) %>%
  data.frame()

L84_2017 %>%
  mutate( "Fuel.Oil..kBtu" = Fuel.Oil..2.Use..kBtu. + Fuel.Oil..4.Use..kBtu. + Fuel.Oil..5...6.Use..kBtu.) -> L84_2017


L84_2016 <- read_excel("data/2016_nyc_benchmarking.xlsx", sheet = "Information and Metrics", col_names = TRUE, na = "NA" )%>% mutate(Sheet = "Information and Metrics") %>%   
  mutate(Data = "2016") %>% data.frame()

L84_2016 %>%
  select(2,5,8,13,14,15,23,24,28,29, 34, 35, 36, 37, 38, 39, 40, 42, 54) -> L84_2016
# select(2:3, 6,9, 14, 16:17, 25:26, 30:31, 33, 37:43, 45:46,48, 61:62 ) %>%
  # data.frame()

# Add Size and age bins
Building_GSF_Ranges <- c("0 to 50,000", "50,000 to 100,000", "100,000 to 500,000", "500,000 to 1,000,000", "over 1,000,000")
L84_2017$bins <- cut(L84_2017$`Self.Reported.Gross.Floor.Area..ft².`, breaks = c(0,50000, 100000, 500000, 1000000, 9000000), dig.lab = 7 , ordered_result = TRUE, labels = Building_GSF_Ranges ) 
Building_Ages <- c("pre 1942", "1942 to 1980", "1980 to 2000")
L84_2017$Year.Range <- cut(L84_2017$Year.Built, breaks = c(0, 1942, 1980, 2021),dig.lab = 4, labels = Building_Ages)
remove(Building_Ages, Building_GSF_Ranges) #clean up environment

# Add total thermal 
#L84_2017[is.na(L84_2017)] <- 0 
L84_2017 %>% 
    mutate("Total.Thermal.(kBTU)" = (Fuel.Oil..1.Use..kBtu. + Fuel.Oil..2.Use..kBtu.+    Fuel.Oil..4.Use..kBtu. + Fuel.Oil..5...6.Use..kBtu.+  Diesel..2.Use..kBtu. + Propane.Use..kBtu. + District.Steam.Use..kBtu. + Natural.Gas.Use..kBtu.)) -> L84_2017

# Add Oil grades together
L84_2017 %>% 
  mutate(Oil = Fuel.Oil..1.Use..kBtu. + Fuel.Oil..2.Use..kBtu. + Fuel.Oil..4.Use..kBtu. + Fuel.Oil..5...6.Use..kBtu.) %>%
  select(-14,-15,-16,-17) -> L84_2017

# Add district chilled water to electric 
L84_2017 %>% 
mutate( Electricity.kBtu. = Electricity.Use...Grid.Purchase..kBtu. + District.Chilled.Water.Use..kBtu.) %>%
  select(-17) -> L84_2017


#L84_2017Multi <- read_excel("data/2017_nyc_benchmarking.xlsx", sheet = "Multi-BBL", col_names #= TRUE, na = "NA") %>% mutate(Sheet = "Multi-BBL")

#L84_2017 <- rbind(L84_2017InM, L84_2017Multi ) %>%   
#  mutate(Data = "2017") %>%
#  select(1:3, 6,9, 14, 16:17, 25:26, 30:31, 33, 37:43, 45:46,48, 61:62 ) %>%
#  data.frame() 
# remove(L84_2017InM, L84_2017Multi)

L84_2017 %>%
  distinct(Property.Id, .keep_all = TRUE) %>% 
  filter(Primary.Property.Type...Self.Selected == "Office") %>%
  filter(Sheet == "Information and Metrics") %>%
  filter( Property.Id != 5820492)  ->L84_2017


####################################





L84_2017 %>% 
  filter(District.Steam.Use..kBtu. != "NA") %>%
  select(Property.Name, District.Steam.Use..kBtu.) %>%
  arrange(District.Steam.Use..kBtu.) %>%  
  tail(-10) %>%
  ggplot(aes(x = District.Steam.Use..kBtu.)) +
  geom_density() 


L84_2017 %>% 
  filter(District.Steam.Use..kBtu. != "NA") %>%
  select(Property.Name, District.Steam.Use..kBtu.) %>%
  arrange(District.Steam.Use..kBtu.) %>%  
  tail(-10) %>% 
  ggplot(aes(y = District.Steam.Use..kBtu.)) +
  geom_boxplot()

L84_2017 %>% 
  filter(District.Steam.Use..kBtu. != "NA") %>%
  select(Property.Name, District.Steam.Use..kBtu.) %>%
  arrange(District.Steam.Use..kBtu.) %>%  
  tail(-10) -> L84_2017_S

#####################################

# Remove bad data - steam outliers and 65 Broadway which skewes the data even with outliers taken out 
L84_2017_S <- L84_2017
outliers <- boxplot(L84_2017$District.Steam.Use..kBtu., plot = FALSE)$out
L84_2017 <- L84_2017[-which(L84_2017_S$District.Steam.Use..kBtu. %in% outliers), ]
remove(outliers)




L84_2017_S %>% 
  ggplot(aes(x = `District.Steam.Use..kBtu.`)) + 
  geom_density() +
  geom_vline(xintercept=mean(L84_2017$`District.Steam.Use..kBtu.` , na.rm = TRUE) ,color="blue", linetype="dashed", size=1)

# Remove bad data - gas outliers  
L84_2017_S_G <- L84_2017_S
outliers <- boxplot(L84_2017_S_G$Natural.Gas.Use..kBtu. , plot = FALSE)$out
L84_2017_S_G <- L84_2017_S_G[-which(L84_2017_S_G$Natural.Gas.Use..kBtu. %in% outliers), ]
remove(outliers, L84_2017_S)

```


```{r, echo = FALSE, message = FALSE, warning = FALSE}


L84_2017 %>% group_by(Primary.Property.Type...Self.Selected) %>%
  summarise("GSF" = sum(`Self.Reported.Gross.Floor.Area..ft².`),  "NGas.(kBtu)" = sum(Natural.Gas.Use..kBtu. , na.rm = TRUE ), "Oil" = sum(Oil , na.rm = TRUE), "Diesel.(kBtu)" = sum(Diesel..2.Use..kBtu., na.rm = TRUE), "Propane.(kBtu)" = sum(Propane.Use..kBtu., na.rm = TRUE), "Steam.(kBtu)" = sum(District.Steam.Use..kBtu., na.rm = TRUE), "Elect.(kBtu)" = sum(Electricity.Use...Grid.Purchase..kBtu., na.rm = TRUE))  -> Total_Energy_by_Prop



```

What is the total thermal energy as reported through the Benchamrking
Law, and how does that compair to Electrical energy used in the same
buildings.

Use the information file.

```{r, echo = FALSE, message = FALSE, warning = FALSE}

# Total Energy by Fuel Type
Total_Energy_by_Prop %>%

  gather(key = "Fuel.Source", value = "kBtu", -Primary.Property.Type...Self.Selected, -GSF) %>%
  arrange(desc(kBtu))%>%
  mutate(Fuel.Source = factor(Fuel.Source, levels = unique(Fuel.Source))) %>%  
  ggplot(aes(x = Fuel.Source, y=kBtu, fill = Fuel.Source)) +
  geom_col() + theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  ggtitle("Total Energy by Fuel Type") -> TotalEnergy_by_FuelType
  ggsave(filename =  "Energy_by_Type.jpeg", device = "jpeg", scale = 1, width = 6, height = 4, bg = "grey")

  TotalEnergy_by_FuelType
  
  # Total Energy by Fuel Type and Property
Total.Energy %>%
  ggplot(aes(x = Primary.Property.Type...Self.Selected , y=kBtu, fill = Fuel.Source)) +
  geom_col() + theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  ggtitle("Total Energy by Fuel Type by Property") ->  TotalEnergy_by_Fuel_by_Prop
  ggsave(filename =  "Energy_by_Type_by_Prop.jpeg", device = "jpeg", scale = 1, width = 6, height = 4, bg = "grey")

  TotalEnergy_by_Fuel_by_Prop
  
  
```





```{r, echo = FALSE, message = FALSE, warning = FALSE}

  
# Make a box plot showing fule type statics in a box plot
L84_2017_S_G %>%
  gather(key = "Fuel.Source", value = "kBtu") %>%
  filter(Fuel.Source == "District.Steam.Use..kBtu.") %>%
  mutate(Fuel.Source = factor(Fuel.Source, levels = unique(Fuel.Source))) %>% 
  ggplot(aes(x = Fuel.Source, y=kBtu, fill = Fuel.Source) ) +
  geom_boxplot() + theme(axis.text.x = element_text(angle = 60, hjust = 1))
  
L84_2017 %>% select(Fuel.Oil..1.Use..kBtu., Fuel.Oil..2.Use..kBtu., Fuel.Oil..4.Use..kBtu., Fuel.Oil..5...6.Use..kBtu., Diesel..2.Use..kBtu., Propane.Use..kBtu., District.Steam.Use..kBtu., Natural.Gas.Use..kBtu., Electricity.Use...Grid.Purchase..kBtu.) %>%
  gather(key = "Fuel.Source", value = "kBtu") %>%
  filter(Fuel.Source == "District.Steam.Use..kBtu.") -> temp
summary(temp$kBtu)

  
Total.Energy%>%
  mutate("Total.Thermal.(kBtu)" = `NGas.(kBtu)`+ Oil.No1 + Oil.No2 + `Oil,No4` + `Oil.No5&6`+ `Diesel.(kBtu)`+ `Propane.(kBtu)`+ `Steam.(kBtu)`) %>%
  select(`Total.Thermal.(kBtu)`, `Elect.(kBtu)`) %>%
  gather(key = "Fuel.Source", value = "kBtu" ) %>% 
  arrange(desc(kBtu))%>%
  mutate(Fuel.Source = factor(Fuel.Source, levels = unique(Fuel.Source))) %>% 
  ggplot(aes(x = Fuel.Source, y=kBtu, fill = Fuel.Source) ) +
  geom_col() + theme(axis.text.x = element_text(angle = 60, hjust = 1))

L84_2017 %>% 
  ggplot(aes(x = `Site/Source EUI`)) +
  geom_density()

#Note how EUI ratio is lower for all electric buildings. 

L84_2017 %>%
  filter(`Total.Thermal (kBTU)`== 0) %>%
  ggplot(aes(x = `Site/Source EUI`)) +
  geom_density()

```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
#EUI 
L84_2017 %>% 
  filter(`Site.EUI..kBtu.ft².` < 500) %>%
  ggplot(aes( x = Property.Type, y = EUI, color = Property.Type)) +
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))

L84_2017 %>% 
  ggplot(aes(x = `EUI (Thermal/Total)`)) + 
  geom_density() +
  geom_vline(xintercept=mean(L84_2017$`EUI (Thermal/Total)` , na.rm = TRUE) ,color="blue", linetype="dashed", size=1)

#EUI by type and range
L84_2017 %>% filter(`Site.EUI..kBtu.ft².` < 500) %>%
  filter(Property.Type == "Office" | Property.Type == "Multifamily" ) %>%
  ggplot(aes( x = Year.Range, y = EUI, color = Property.Type, fill=Property.Type)) +
  geom_boxplot()

L84_2017 %>% 
  select(`Self.Reported.Gross.Floor.Area..ft².`, Number.of.Buildings, District.Steam.Use..kBtu.) %>%
  na.omit() 
#  summarise(Gross.SF = sum(Self.Reported.Gross.Floor.Area..ft².), Buildings = 
# sum(Number.of.Buildings), Steam = sum(District.Steam.Use..kBtu.))

```

